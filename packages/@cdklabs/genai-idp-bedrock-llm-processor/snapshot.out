Resources:
  InputBucket3BF8630A:
    Type: AWS::S3::Bucket
    Properties:
      Tags:
        - Key: aws-cdk:auto-delete-objects
          Value: "true"
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  InputBucketPolicy84EF9809:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket:
        Ref: InputBucket3BF8630A
      PolicyDocument:
        Statement:
          - Action:
              - s3:PutBucketPolicy
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
            Effect: Allow
            Principal:
              AWS:
                Fn::GetAtt:
                  - CustomS3AutoDeleteObjectsCustomResourceProviderRole3B1BD092
                  - Arn
            Resource:
              - Fn::GetAtt:
                  - InputBucket3BF8630A
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - InputBucket3BF8630A
                        - Arn
                    - /*
        Version: "2012-10-17"
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  InputBucketAutoDeleteObjectsCustomResourceE0706273:
    Type: Custom::S3AutoDeleteObjects
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - CustomS3AutoDeleteObjectsCustomResourceProviderHandler9D90184F
          - Arn
      BucketName:
        Ref: InputBucket3BF8630A
    DependsOn:
      - InputBucketPolicy84EF9809
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  InputBucketNotificationsA82F925B:
    Type: Custom::S3BucketNotifications
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - BucketNotificationsHandler050a0587b7544547bf325f094a3db8347ECC3691
          - Arn
      BucketName:
        Ref: InputBucket3BF8630A
      NotificationConfiguration:
        EventBridgeConfiguration: {}
      Managed: true
      SkipDestinationValidation: false
    DependsOn:
      - InputBucketPolicy84EF9809
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  CustomS3AutoDeleteObjectsCustomResourceProviderRole3B1BD092:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
      ManagedPolicyArns:
        - Fn::Sub: arn:${AWS::Partition}:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  CustomS3AutoDeleteObjectsCustomResourceProviderHandler9D90184F:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Fn::Sub: cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}
        S3Key: faa95a81ae7d7373f3e1f242268f904eb748d8d0fdd306e8a6fe515a1905a7d6.zip
      Timeout: 900
      MemorySize: 128
      Handler: index.handler
      Role:
        Fn::GetAtt:
          - CustomS3AutoDeleteObjectsCustomResourceProviderRole3B1BD092
          - Arn
      Runtime:
        Fn::FindInMap:
          - LatestNodeRuntimeMap
          - Ref: AWS::Region
          - value
      Description:
        Fn::Join:
          - ""
          - - "Lambda function for auto-deleting objects in "
            - Ref: InputBucket3BF8630A
            - " S3 bucket."
    DependsOn:
      - CustomS3AutoDeleteObjectsCustomResourceProviderRole3B1BD092
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleB6FB88EC:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleDefaultPolicy2CF63D36:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: s3:PutBucketNotification
            Effect: Allow
            Resource: "*"
        Version: "2012-10-17"
      PolicyName: BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleDefaultPolicy2CF63D36
      Roles:
        - Ref: BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleB6FB88EC
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  BucketNotificationsHandler050a0587b7544547bf325f094a3db8347ECC3691:
    Type: AWS::Lambda::Function
    Properties:
      Description: AWS CloudFormation handler for "Custom::S3BucketNotifications" resources (@aws-cdk/aws-s3)
      Code:
        ZipFile: |-
          import boto3  # type: ignore
          import json
          import logging
          import urllib.request

          s3 = boto3.client("s3")

          EVENTBRIDGE_CONFIGURATION = 'EventBridgeConfiguration'
          CONFIGURATION_TYPES = ["TopicConfigurations", "QueueConfigurations", "LambdaFunctionConfigurations"]

          def handler(event: dict, context):
            response_status = "SUCCESS"
            error_message = ""
            try:
              props = event["ResourceProperties"]
              notification_configuration = props["NotificationConfiguration"]
              managed = props.get('Managed', 'true').lower() == 'true'
              skipDestinationValidation = props.get('SkipDestinationValidation', 'false').lower() == 'true'
              stack_id = event['StackId']
              old = event.get("OldResourceProperties", {}).get("NotificationConfiguration", {})
              if managed:
                config = handle_managed(event["RequestType"], notification_configuration)
              else:
                config = handle_unmanaged(props["BucketName"], stack_id, event["RequestType"], notification_configuration, old)
              s3.put_bucket_notification_configuration(Bucket=props["BucketName"], NotificationConfiguration=config, SkipDestinationValidation=skipDestinationValidation)
            except Exception as e:
              logging.exception("Failed to put bucket notification configuration")
              response_status = "FAILED"
              error_message = f"Error: {str(e)}. "
            finally:
              submit_response(event, context, response_status, error_message)

          def handle_managed(request_type, notification_configuration):
            if request_type == 'Delete':
              return {}
            return notification_configuration

          def handle_unmanaged(bucket, stack_id, request_type, notification_configuration, old):
            def get_id(n):
              n['Id'] = ''
              sorted_notifications = sort_filter_rules(n)
              strToHash=json.dumps(sorted_notifications, sort_keys=True).replace('"Name": "prefix"', '"Name": "Prefix"').replace('"Name": "suffix"', '"Name": "Suffix"')
              return f"{stack_id}-{hash(strToHash)}"
            def with_id(n):
              n['Id'] = get_id(n)
              return n

            external_notifications = {}
            existing_notifications = s3.get_bucket_notification_configuration(Bucket=bucket)
            for t in CONFIGURATION_TYPES:
              if request_type == 'Update':
                  old_incoming_ids = [get_id(n) for n in old.get(t, [])]
                  external_notifications[t] = [n for n in existing_notifications.get(t, []) if not get_id(n) in old_incoming_ids]      
              elif request_type == 'Delete':
                  external_notifications[t] = [n for n in existing_notifications.get(t, []) if not n['Id'].startswith(f"{stack_id}-")]
              elif request_type == 'Create':
                  external_notifications[t] = [n for n in existing_notifications.get(t, [])]
            if EVENTBRIDGE_CONFIGURATION in existing_notifications:
              external_notifications[EVENTBRIDGE_CONFIGURATION] = existing_notifications[EVENTBRIDGE_CONFIGURATION]

            if request_type == 'Delete':
              return external_notifications

            notifications = {}
            for t in CONFIGURATION_TYPES:
              external = external_notifications.get(t, [])
              incoming = [with_id(n) for n in notification_configuration.get(t, [])]
              notifications[t] = external + incoming

            if EVENTBRIDGE_CONFIGURATION in notification_configuration:
              notifications[EVENTBRIDGE_CONFIGURATION] = notification_configuration[EVENTBRIDGE_CONFIGURATION]
            elif EVENTBRIDGE_CONFIGURATION in external_notifications:
              notifications[EVENTBRIDGE_CONFIGURATION] = external_notifications[EVENTBRIDGE_CONFIGURATION]

            return notifications

          def submit_response(event: dict, context, response_status: str, error_message: str):
            response_body = json.dumps(
              {
                "Status": response_status,
                "Reason": f"{error_message}See the details in CloudWatch Log Stream: {context.log_stream_name}",
                "PhysicalResourceId": event.get("PhysicalResourceId") or event["LogicalResourceId"],
                "StackId": event["StackId"],
                "RequestId": event["RequestId"],
                "LogicalResourceId": event["LogicalResourceId"],
                "NoEcho": False,
              }
            ).encode("utf-8")
            headers = {"content-type": "", "content-length": str(len(response_body))}
            try:
              req = urllib.request.Request(url=event["ResponseURL"], headers=headers, data=response_body, method="PUT")
              with urllib.request.urlopen(req) as response:
                print(response.read().decode("utf-8"))
              print("Status code: " + response.reason)
            except Exception as e:
                print("send(..) failed executing request.urlopen(..): " + str(e))

          def sort_filter_rules(json_obj):
            if not isinstance(json_obj, dict):
                return json_obj
            for key, value in json_obj.items():
                if isinstance(value, dict):
                    json_obj[key] = sort_filter_rules(value)
                elif isinstance(value, list):
                    json_obj[key] = [sort_filter_rules(item) for item in value]
            if "Filter" in json_obj and "Key" in json_obj["Filter"] and "FilterRules" in json_obj["Filter"]["Key"]:
                filter_rules = json_obj["Filter"]["Key"]["FilterRules"]
                sorted_filter_rules = sorted(filter_rules, key=lambda x: x["Name"])
                json_obj["Filter"]["Key"]["FilterRules"] = sorted_filter_rules
            return json_obj
      Handler: index.handler
      Role:
        Fn::GetAtt:
          - BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleB6FB88EC
          - Arn
      Runtime: python3.11
      Timeout: 300
    DependsOn:
      - BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleDefaultPolicy2CF63D36
      - BucketNotificationsHandler050a0587b7544547bf325f094a3db834RoleB6FB88EC
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  OutputBucket7114EB27:
    Type: AWS::S3::Bucket
    Properties:
      Tags:
        - Key: aws-cdk:auto-delete-objects
          Value: "true"
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  OutputBucketPolicyAE009DDC:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket:
        Ref: OutputBucket7114EB27
      PolicyDocument:
        Statement:
          - Action:
              - s3:PutBucketPolicy
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
            Effect: Allow
            Principal:
              AWS:
                Fn::GetAtt:
                  - CustomS3AutoDeleteObjectsCustomResourceProviderRole3B1BD092
                  - Arn
            Resource:
              - Fn::GetAtt:
                  - OutputBucket7114EB27
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - OutputBucket7114EB27
                        - Arn
                    - /*
        Version: "2012-10-17"
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  OutputBucketAutoDeleteObjectsCustomResource6C7A161F:
    Type: Custom::S3AutoDeleteObjects
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - CustomS3AutoDeleteObjectsCustomResourceProviderHandler9D90184F
          - Arn
      BucketName:
        Ref: OutputBucket7114EB27
    DependsOn:
      - OutputBucketPolicyAE009DDC
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ConfigurationBucketECC78386:
    Type: AWS::S3::Bucket
    Properties:
      Tags:
        - Key: aws-cdk:auto-delete-objects
          Value: "true"
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ConfigurationBucketPolicyC8D538FC:
    Type: AWS::S3::BucketPolicy
    Properties:
      Bucket:
        Ref: ConfigurationBucketECC78386
      PolicyDocument:
        Statement:
          - Action:
              - s3:PutBucketPolicy
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
            Effect: Allow
            Principal:
              AWS:
                Fn::GetAtt:
                  - CustomS3AutoDeleteObjectsCustomResourceProviderRole3B1BD092
                  - Arn
            Resource:
              - Fn::GetAtt:
                  - ConfigurationBucketECC78386
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - ConfigurationBucketECC78386
                        - Arn
                    - /*
        Version: "2012-10-17"
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ConfigurationBucketAutoDeleteObjectsCustomResourceB4D9F963:
    Type: Custom::S3AutoDeleteObjects
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - CustomS3AutoDeleteObjectsCustomResourceProviderHandler9D90184F
          - Arn
      BucketName:
        Ref: ConfigurationBucketECC78386
    DependsOn:
      - ConfigurationBucketPolicyC8D538FC
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentConcurrencyTableE6976F31:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: counter_id
          AttributeType: S
      KeySchema:
        - AttributeName: counter_id
          KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentConcurrencyTableInitializeConcurrencyTableLambdaServiceRole796A836E:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentConcurrencyTableInitializeConcurrencyTableLambdaServiceRoleDefaultPolicy63CB12D0:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - dynamodb:BatchGetItem
              - dynamodb:GetRecords
              - dynamodb:GetShardIterator
              - dynamodb:Query
              - dynamodb:GetItem
              - dynamodb:Scan
              - dynamodb:ConditionCheckItem
              - dynamodb:BatchWriteItem
              - dynamodb:PutItem
              - dynamodb:UpdateItem
              - dynamodb:DeleteItem
              - dynamodb:DescribeTable
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - EnvironmentConcurrencyTableE6976F31
                  - Arn
              - Ref: AWS::NoValue
        Version: "2012-10-17"
      PolicyName: EnvironmentConcurrencyTableInitializeConcurrencyTableLambdaServiceRoleDefaultPolicy63CB12D0
      Roles:
        - Ref: EnvironmentConcurrencyTableInitializeConcurrencyTableLambdaServiceRole796A836E
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentConcurrencyTableInitializeConcurrencyTableLambdaB87539A8:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Fn::Sub: cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}
        S3Key: 1b277fec345adf92744543f64179a0171fcc4a243ea0871061a134aee8928f17.zip
      Environment:
        Variables:
          CONCURRENCY_TABLE:
            Ref: EnvironmentConcurrencyTableE6976F31
      Handler: index.handler
      Role:
        Fn::GetAtt:
          - EnvironmentConcurrencyTableInitializeConcurrencyTableLambdaServiceRole796A836E
          - Arn
      Runtime: python3.12
      Timeout: 30
    DependsOn:
      - EnvironmentConcurrencyTableInitializeConcurrencyTableLambdaServiceRoleDefaultPolicy63CB12D0
      - EnvironmentConcurrencyTableInitializeConcurrencyTableLambdaServiceRole796A836E
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentConcurrencyTableInitializeConcurrencyTableCustomResource9AAD570D:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - EnvironmentConcurrencyTableInitializeConcurrencyTableLambdaB87539A8
          - Arn
      TableName:
        Ref: EnvironmentConcurrencyTableE6976F31
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiD8145510:
    Type: AWS::AppSync::GraphQLApi
    Properties:
      AuthenticationType: AWS_IAM
      Name: Pattern2TestStackEnvironmentApiD2565E10
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiSchemaCED14B43:
    Type: AWS::AppSync::GraphQLSchema
    Properties:
      ApiId:
        Fn::GetAtt:
          - EnvironmentApiD8145510
          - ApiId
      Definition: |
        interface DynamoDbBase {
        	PK: ID!
        	SK: ID!
        	ExpiresAfter: AWSTimestamp
        }

        type Document implements DynamoDbBase @aws_cognito_user_pools @aws_iam {
          PK: ID!
          SK: ID!
          ObjectKey: ID
          ObjectStatus: String
          InitialEventTime: AWSDateTime
          QueuedTime: AWSDateTime
          WorkflowStartTime: AWSDateTime
          CompletionTime: AWSDateTime
          WorkflowExecutionArn: String
          WorkflowStatus: String
          PageCount: Int
          Sections: [Section]
          Pages: [Page]
          Metering: AWSJSON
          EvaluationReportUri: String
          EvaluationStatus: String
          SummaryReportUri: String
          ExpiresAfter: AWSTimestamp
        }

        type Section @aws_cognito_user_pools @aws_iam {
          Id: String
          PageIds: [ Int ]
          Class: String
          OutputJSONUri: String
        }

        type Page @aws_cognito_user_pools @aws_iam {
          Id: Int
          Class: String
          ImageUri: String
          TextUri: String
        }

        type DocumentList @aws_cognito_user_pools @aws_iam {
        	Documents: [DocumentListItem]
        	nextToken: String
        }

        type DocumentListItem implements DynamoDbBase @aws_cognito_user_pools @aws_iam {
        	PK: ID!
        	SK: ID!
            ObjectKey: ID
            InitialEventTime: AWSDateTime
            ExpiresAfter: AWSTimestamp
        }

        type ConfigurationResponse @aws_cognito_user_pools @aws_iam {
          Schema: AWSJSON
          Default: AWSJSON
          Custom: AWSJSON
        }

        input CreateDocumentInput {
          ObjectKey: ID
          ObjectStatus: String
          InitialEventTime: AWSDateTime
          QueuedTime: AWSDateTime
          ExpiresAfter: AWSTimestamp
        }

        type CreateDocumentOutput @aws_iam {
          ObjectKey: ID
        }

        type PresignedUrlResponse @aws_cognito_user_pools {
          presignedUrl: String!
          objectKey: String!
          usePostMethod: String!
        }

        input UpdateDocumentInput {
          ObjectKey: ID!
          ObjectStatus: String
          QueuedTime: AWSDateTime
          WorkflowStartTime: AWSDateTime
          CompletionTime: AWSDateTime
          WorkflowExecutionArn: String
          WorkflowStatus: String
          PageCount: Int
          Sections: [SectionInput]
          Pages: [PageInput]
          Metering: AWSJSON
          EvaluationReportUri: String
          EvaluationStatus: String
          SummaryReportUri: String
        }

        input SectionInput {
          Id: String
          PageIds: [ Int ]
          Class: String
          OutputJSONUri: String
        }

        input PageInput {
          Id: Int
          Class: String
          ImageUri: String
          TextUri: String
        }

        type CopyToBaselineResponse @aws_cognito_user_pools {
          success: Boolean!
          message: String
        }

        type FileContentsResponse @aws_cognito_user_pools @aws_iam {
          content: String!
          contentType: String!
          size: Int!
          isBinary: Boolean
        }

        type Mutation  {
          createDocument(input: CreateDocumentInput!): CreateDocumentOutput @aws_iam
          updateDocument(input: UpdateDocumentInput!): Document @aws_iam
          deleteDocument(objectKeys: [String!]!): Boolean! @aws_cognito_user_pools
          updateConfiguration(customConfig: AWSJSON!): Boolean @aws_cognito_user_pools
          uploadDocument(fileName: String!, contentType: String, prefix: String, bucket: String): PresignedUrlResponse! @aws_cognito_user_pools
          copyToBaseline(objectKey: String!): CopyToBaselineResponse! @aws_cognito_user_pools
          reprocessDocument(objectKeys: [String!]!): Boolean! @aws_cognito_user_pools
        }

        type Query @aws_cognito_user_pools @aws_iam {
          getDocument(ObjectKey: ID!): Document
          listDocuments(startDateTime: AWSDateTime, endDateTime: AWSDateTime): DocumentList
          listDocumentsDateHour(date: AWSDate, hour: Int): DocumentList
          listDocumentsDateShard(date: AWSDate, shard: Int): DocumentList 
          getFileContents(s3Uri: String!): FileContentsResponse
          getConfiguration: ConfigurationResponse
          queryKnowledgeBase(input: String!, sessionId: String): String
        }

        type Subscription @aws_cognito_user_pools @aws_iam {
          onCreateDocument: CreateDocumentOutput
        	@aws_subscribe(mutations: ["createDocument"])
          onUpdateDocument: Document
            @aws_subscribe(mutations: ["updateDocument"])
        }

        schema {
          query: Query
          mutation: Mutation
          subscription: Subscription
        }
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiGetFileContentsResolverLogGroupD85666A3:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 7
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiGetFileContentsResolverFunctionServiceRoleB8DF56AE:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiGetFileContentsResolverFunctionServiceRoleDefaultPolicy4D3B3DBA:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - InputBucket3BF8630A
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - InputBucket3BF8630A
                        - Arn
                    - /*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - OutputBucket7114EB27
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - OutputBucket7114EB27
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: EnvironmentApiGetFileContentsResolverFunctionServiceRoleDefaultPolicy4D3B3DBA
      Roles:
        - Ref: EnvironmentApiGetFileContentsResolverFunctionServiceRoleB8DF56AE
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiGetFileContentsResolverFunction31E2AB8F:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Fn::Sub: cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}
        S3Key: 31ec1a168866472196416f1a97d81666bbe1129e03698ea0650feb342cc95ab8.zip
      Description: This AWS Lambda Function gets the contents of a file from S3.
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: EnvironmentApiGetFileContentsResolverLogGroupD85666A3
      MemorySize: 512
      Role:
        Fn::GetAtt:
          - EnvironmentApiGetFileContentsResolverFunctionServiceRoleB8DF56AE
          - Arn
      Runtime: python3.12
      Timeout: 60
    DependsOn:
      - EnvironmentApiGetFileContentsResolverFunctionServiceRoleDefaultPolicy4D3B3DBA
      - EnvironmentApiGetFileContentsResolverFunctionServiceRoleB8DF56AE
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiGetFileContentsDataSourceServiceRoleB5F7EF49:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: appsync.amazonaws.com
        Version: "2012-10-17"
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiGetFileContentsDataSourceServiceRoleDefaultPolicy70166C6A:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: lambda:InvokeFunction
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - EnvironmentApiGetFileContentsResolverFunction31E2AB8F
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - EnvironmentApiGetFileContentsResolverFunction31E2AB8F
                        - Arn
                    - :*
        Version: "2012-10-17"
      PolicyName: EnvironmentApiGetFileContentsDataSourceServiceRoleDefaultPolicy70166C6A
      Roles:
        - Ref: EnvironmentApiGetFileContentsDataSourceServiceRoleB5F7EF49
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiGetFileContentsDataSource689B22B4:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId:
        Fn::GetAtt:
          - EnvironmentApiD8145510
          - ApiId
      Description: Get the contents of a file from S3
      LambdaConfig:
        LambdaFunctionArn:
          Fn::GetAtt:
            - EnvironmentApiGetFileContentsResolverFunction31E2AB8F
            - Arn
      Name: GetFileContentsResolver
      ServiceRoleArn:
        Fn::GetAtt:
          - EnvironmentApiGetFileContentsDataSourceServiceRoleB5F7EF49
          - Arn
      Type: AWS_LAMBDA
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiGetFileContentsResolver3A46FAB7:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId:
        Fn::GetAtt:
          - EnvironmentApiD8145510
          - ApiId
      DataSourceName: GetFileContentsResolver
      FieldName: getFileContents
      Kind: UNIT
      TypeName: Query
    DependsOn:
      - EnvironmentApiGetFileContentsDataSource689B22B4
      - EnvironmentApiSchemaCED14B43
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiDeleteDocumentResolverFunctionLogGroup5E18E10D:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 7
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiDeleteDocumentResolverFunctionServiceRole7B4C7559:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiDeleteDocumentResolverFunctionServiceRoleDefaultPolicy5B2383FD:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - dynamodb:BatchGetItem
              - dynamodb:GetRecords
              - dynamodb:GetShardIterator
              - dynamodb:Query
              - dynamodb:GetItem
              - dynamodb:Scan
              - dynamodb:ConditionCheckItem
              - dynamodb:BatchWriteItem
              - dynamodb:PutItem
              - dynamodb:UpdateItem
              - dynamodb:DeleteItem
              - dynamodb:DescribeTable
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - EnvironmentTrackingTable97AE1FE4
                  - Arn
              - Ref: AWS::NoValue
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject
              - s3:PutObjectLegalHold
              - s3:PutObjectRetention
              - s3:PutObjectTagging
              - s3:PutObjectVersionTagging
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - InputBucket3BF8630A
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - InputBucket3BF8630A
                        - Arn
                    - /*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject
              - s3:PutObjectLegalHold
              - s3:PutObjectRetention
              - s3:PutObjectTagging
              - s3:PutObjectVersionTagging
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - OutputBucket7114EB27
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - OutputBucket7114EB27
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: EnvironmentApiDeleteDocumentResolverFunctionServiceRoleDefaultPolicy5B2383FD
      Roles:
        - Ref: EnvironmentApiDeleteDocumentResolverFunctionServiceRole7B4C7559
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiDeleteDocumentResolverFunction418ACBEC:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Fn::Sub: cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}
        S3Key: 6d4202f15764312e12525c866ef71c278a76471b8d8c06ef58d149969d03281e.zip
      Description: Lambda function to delete documents via GraphQL API
      Environment:
        Variables:
          TRACKING_TABLE:
            Ref: EnvironmentTrackingTable97AE1FE4
          INPUT_BUCKET:
            Ref: InputBucket3BF8630A
          OUTPUT_BUCKET:
            Ref: OutputBucket7114EB27
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: EnvironmentApiDeleteDocumentResolverFunctionLogGroup5E18E10D
      MemorySize: 512
      Role:
        Fn::GetAtt:
          - EnvironmentApiDeleteDocumentResolverFunctionServiceRole7B4C7559
          - Arn
      Runtime: python3.12
      Timeout: 30
    DependsOn:
      - EnvironmentApiDeleteDocumentResolverFunctionServiceRoleDefaultPolicy5B2383FD
      - EnvironmentApiDeleteDocumentResolverFunctionServiceRole7B4C7559
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiDeleteDocumentDataSourceServiceRole7A2B88C9:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: appsync.amazonaws.com
        Version: "2012-10-17"
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiDeleteDocumentDataSourceServiceRoleDefaultPolicyF31AB405:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: lambda:InvokeFunction
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - EnvironmentApiDeleteDocumentResolverFunction418ACBEC
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - EnvironmentApiDeleteDocumentResolverFunction418ACBEC
                        - Arn
                    - :*
        Version: "2012-10-17"
      PolicyName: EnvironmentApiDeleteDocumentDataSourceServiceRoleDefaultPolicyF31AB405
      Roles:
        - Ref: EnvironmentApiDeleteDocumentDataSourceServiceRole7A2B88C9
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiDeleteDocumentDataSource3FADAE65:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId:
        Fn::GetAtt:
          - EnvironmentApiD8145510
          - ApiId
      Description: Lambda function for deleting documents
      LambdaConfig:
        LambdaFunctionArn:
          Fn::GetAtt:
            - EnvironmentApiDeleteDocumentResolverFunction418ACBEC
            - Arn
      Name: DeleteDocumentDataSource
      ServiceRoleArn:
        Fn::GetAtt:
          - EnvironmentApiDeleteDocumentDataSourceServiceRole7A2B88C9
          - Arn
      Type: AWS_LAMBDA
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiDeleteDocumentResolver781D7C60:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId:
        Fn::GetAtt:
          - EnvironmentApiD8145510
          - ApiId
      DataSourceName: DeleteDocumentDataSource
      FieldName: deleteDocument
      Kind: UNIT
      TypeName: Mutation
    DependsOn:
      - EnvironmentApiDeleteDocumentDataSource3FADAE65
      - EnvironmentApiSchemaCED14B43
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiCopyToBaselineResolverFunctionLogGroup8444C8B4:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 7
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiCopyToBaselineResolverFunctionServiceRole3D8F29C8:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiCopyToBaselineResolverFunctionServiceRoleDefaultPolicy6D2550D9:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject
              - s3:PutObjectLegalHold
              - s3:PutObjectRetention
              - s3:PutObjectTagging
              - s3:PutObjectVersionTagging
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - OutputBucket7114EB27
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - OutputBucket7114EB27
                        - Arn
                    - /*
          - Action: lambda:InvokeFunction
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":lambda:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :function:CopyToBaselineResolverFunctionb2acf6a5Api
          - Action: appsync:GraphQL
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - Fn::GetAtt:
                      - EnvironmentApiD8145510
                      - Arn
                  - /types/Mutation/*
        Version: "2012-10-17"
      PolicyName: EnvironmentApiCopyToBaselineResolverFunctionServiceRoleDefaultPolicy6D2550D9
      Roles:
        - Ref: EnvironmentApiCopyToBaselineResolverFunctionServiceRole3D8F29C8
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiCopyToBaselineResolverFunction97812AB1:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Fn::Sub: cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}
        S3Key: d9d986bbf093fc44dfa17e8d2e1de239a5fc2eb51a7578ad809269811d00df46.zip
      Description: Lambda function to copy files to baseline bucket via GraphQL API
      Environment:
        Variables:
          OUTPUT_BUCKET:
            Ref: OutputBucket7114EB27
          EVALUATION_BASELINE_BUCKET: ""
          GRAPHQL_API_URL:
            Fn::GetAtt:
              - EnvironmentApiD8145510
              - GraphQLUrl
      FunctionName: CopyToBaselineResolverFunctionb2acf6a5Api
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: EnvironmentApiCopyToBaselineResolverFunctionLogGroup8444C8B4
      MemorySize: 512
      Role:
        Fn::GetAtt:
          - EnvironmentApiCopyToBaselineResolverFunctionServiceRole3D8F29C8
          - Arn
      Runtime: python3.12
      Timeout: 30
    DependsOn:
      - EnvironmentApiCopyToBaselineResolverFunctionServiceRoleDefaultPolicy6D2550D9
      - EnvironmentApiCopyToBaselineResolverFunctionServiceRole3D8F29C8
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiCopyToBaselineDataSourceServiceRoleFBBAE52E:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: appsync.amazonaws.com
        Version: "2012-10-17"
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiCopyToBaselineDataSourceServiceRoleDefaultPolicy3A638F2D:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: lambda:InvokeFunction
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - EnvironmentApiCopyToBaselineResolverFunction97812AB1
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - EnvironmentApiCopyToBaselineResolverFunction97812AB1
                        - Arn
                    - :*
        Version: "2012-10-17"
      PolicyName: EnvironmentApiCopyToBaselineDataSourceServiceRoleDefaultPolicy3A638F2D
      Roles:
        - Ref: EnvironmentApiCopyToBaselineDataSourceServiceRoleFBBAE52E
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiCopyToBaselineDataSource9A60A152:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId:
        Fn::GetAtt:
          - EnvironmentApiD8145510
          - ApiId
      Description: Lambda function for copying files to baseline bucket
      LambdaConfig:
        LambdaFunctionArn:
          Fn::GetAtt:
            - EnvironmentApiCopyToBaselineResolverFunction97812AB1
            - Arn
      Name: CopyToBaselineDataSource
      ServiceRoleArn:
        Fn::GetAtt:
          - EnvironmentApiCopyToBaselineDataSourceServiceRoleFBBAE52E
          - Arn
      Type: AWS_LAMBDA
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiCopyToBaselineResolverAD5B603B:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId:
        Fn::GetAtt:
          - EnvironmentApiD8145510
          - ApiId
      DataSourceName: CopyToBaselineDataSource
      FieldName: copyToBaseline
      Kind: UNIT
      TypeName: Mutation
    DependsOn:
      - EnvironmentApiCopyToBaselineDataSource9A60A152
      - EnvironmentApiSchemaCED14B43
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiReprocessDocumentResolverFunctionLogGroup507AD44E:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 7
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiReprocessDocumentResolverFunctionServiceRole18A631EB:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiReprocessDocumentResolverFunctionServiceRoleDefaultPolicy3BC07B5E:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject
              - s3:PutObjectLegalHold
              - s3:PutObjectRetention
              - s3:PutObjectTagging
              - s3:PutObjectVersionTagging
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - InputBucket3BF8630A
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - InputBucket3BF8630A
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: EnvironmentApiReprocessDocumentResolverFunctionServiceRoleDefaultPolicy3BC07B5E
      Roles:
        - Ref: EnvironmentApiReprocessDocumentResolverFunctionServiceRole18A631EB
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiReprocessDocumentResolverFunction820D3222:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Fn::Sub: cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}
        S3Key: d506ad25f9986b09b029dc20082fe11ccb9c573c770e44062104a0c09c99f504.zip
      Description: Lambda function to reprocess documents via GraphQL API
      Environment:
        Variables:
          INPUT_BUCKET:
            Ref: InputBucket3BF8630A
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: EnvironmentApiReprocessDocumentResolverFunctionLogGroup507AD44E
      MemorySize: 512
      Role:
        Fn::GetAtt:
          - EnvironmentApiReprocessDocumentResolverFunctionServiceRole18A631EB
          - Arn
      Runtime: python3.12
      Timeout: 30
    DependsOn:
      - EnvironmentApiReprocessDocumentResolverFunctionServiceRoleDefaultPolicy3BC07B5E
      - EnvironmentApiReprocessDocumentResolverFunctionServiceRole18A631EB
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiReprocessDocumentDataSourceServiceRole1F873706:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: appsync.amazonaws.com
        Version: "2012-10-17"
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiReprocessDocumentDataSourceServiceRoleDefaultPolicyC5D2A1FE:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: lambda:InvokeFunction
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - EnvironmentApiReprocessDocumentResolverFunction820D3222
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - EnvironmentApiReprocessDocumentResolverFunction820D3222
                        - Arn
                    - :*
        Version: "2012-10-17"
      PolicyName: EnvironmentApiReprocessDocumentDataSourceServiceRoleDefaultPolicyC5D2A1FE
      Roles:
        - Ref: EnvironmentApiReprocessDocumentDataSourceServiceRole1F873706
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiReprocessDocumentDataSourceAC9DB2C1:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId:
        Fn::GetAtt:
          - EnvironmentApiD8145510
          - ApiId
      Description: Lambda function for reprocessing documents
      LambdaConfig:
        LambdaFunctionArn:
          Fn::GetAtt:
            - EnvironmentApiReprocessDocumentResolverFunction820D3222
            - Arn
      Name: ReprocessDocumentDataSource
      ServiceRoleArn:
        Fn::GetAtt:
          - EnvironmentApiReprocessDocumentDataSourceServiceRole1F873706
          - Arn
      Type: AWS_LAMBDA
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiReprocessDocumentResolver10B30629:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId:
        Fn::GetAtt:
          - EnvironmentApiD8145510
          - ApiId
      DataSourceName: ReprocessDocumentDataSource
      FieldName: reprocessDocument
      Kind: UNIT
      TypeName: Mutation
    DependsOn:
      - EnvironmentApiReprocessDocumentDataSourceAC9DB2C1
      - EnvironmentApiSchemaCED14B43
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiUploadResolverFunctionLogGroup5B1BD18B:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 7
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiUploadResolverFunctionServiceRole948C35A4:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiUploadResolverFunctionServiceRoleDefaultPolicy12B6D712:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - s3:DeleteObject*
              - s3:PutObject
              - s3:PutObjectLegalHold
              - s3:PutObjectRetention
              - s3:PutObjectTagging
              - s3:PutObjectVersionTagging
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - InputBucket3BF8630A
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - InputBucket3BF8630A
                        - Arn
                    - /*
          - Action:
              - s3:DeleteObject*
              - s3:PutObject
              - s3:PutObjectLegalHold
              - s3:PutObjectRetention
              - s3:PutObjectTagging
              - s3:PutObjectVersionTagging
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - OutputBucket7114EB27
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - OutputBucket7114EB27
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: EnvironmentApiUploadResolverFunctionServiceRoleDefaultPolicy12B6D712
      Roles:
        - Ref: EnvironmentApiUploadResolverFunctionServiceRole948C35A4
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiUploadResolverFunctionCB2B4D31:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Fn::Sub: cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}
        S3Key: 87a6ecd06c4a658bcaa89b69ddcbd82049441ffc3f930b46238efcdaff0d23c0.zip
      Description: Lambda function to return signed upload URL via GraphQL API
      Environment:
        Variables:
          INPUT_BUCKET:
            Ref: InputBucket3BF8630A
          OUTPUT_BUCKET:
            Ref: OutputBucket7114EB27
          EVALUATION_BASELINE_BUCKET: ""
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: EnvironmentApiUploadResolverFunctionLogGroup5B1BD18B
      MemorySize: 512
      Role:
        Fn::GetAtt:
          - EnvironmentApiUploadResolverFunctionServiceRole948C35A4
          - Arn
      Runtime: python3.12
      Timeout: 30
    DependsOn:
      - EnvironmentApiUploadResolverFunctionServiceRoleDefaultPolicy12B6D712
      - EnvironmentApiUploadResolverFunctionServiceRole948C35A4
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiUploadResolverDataSourceServiceRole9A4EB2FF:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: appsync.amazonaws.com
        Version: "2012-10-17"
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiUploadResolverDataSourceServiceRoleDefaultPolicy828F590D:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: lambda:InvokeFunction
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - EnvironmentApiUploadResolverFunctionCB2B4D31
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - EnvironmentApiUploadResolverFunctionCB2B4D31
                        - Arn
                    - :*
        Version: "2012-10-17"
      PolicyName: EnvironmentApiUploadResolverDataSourceServiceRoleDefaultPolicy828F590D
      Roles:
        - Ref: EnvironmentApiUploadResolverDataSourceServiceRole9A4EB2FF
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiUploadResolverDataSourceFB532288:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId:
        Fn::GetAtt:
          - EnvironmentApiD8145510
          - ApiId
      Description: Lambda function for generating presigned URLs
      LambdaConfig:
        LambdaFunctionArn:
          Fn::GetAtt:
            - EnvironmentApiUploadResolverFunctionCB2B4D31
            - Arn
      Name: UploadResolverDataSource
      ServiceRoleArn:
        Fn::GetAtt:
          - EnvironmentApiUploadResolverDataSourceServiceRole9A4EB2FF
          - Arn
      Type: AWS_LAMBDA
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiUploadDocumentResolver9DD33536:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId:
        Fn::GetAtt:
          - EnvironmentApiD8145510
          - ApiId
      DataSourceName: UploadResolverDataSource
      FieldName: uploadDocument
      Kind: UNIT
      TypeName: Mutation
    DependsOn:
      - EnvironmentApiSchemaCED14B43
      - EnvironmentApiUploadResolverDataSourceFB532288
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiTrackingTableDataSourceServiceRoleD7C6E0FC:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: appsync.amazonaws.com
        Version: "2012-10-17"
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiTrackingTableDataSourceServiceRoleDefaultPolicyBBC457ED:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - dynamodb:BatchGetItem
              - dynamodb:GetRecords
              - dynamodb:GetShardIterator
              - dynamodb:Query
              - dynamodb:GetItem
              - dynamodb:Scan
              - dynamodb:ConditionCheckItem
              - dynamodb:BatchWriteItem
              - dynamodb:PutItem
              - dynamodb:UpdateItem
              - dynamodb:DeleteItem
              - dynamodb:DescribeTable
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - EnvironmentTrackingTable97AE1FE4
                  - Arn
              - Ref: AWS::NoValue
        Version: "2012-10-17"
      PolicyName: EnvironmentApiTrackingTableDataSourceServiceRoleDefaultPolicyBBC457ED
      Roles:
        - Ref: EnvironmentApiTrackingTableDataSourceServiceRoleD7C6E0FC
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiTrackingTableDataSource3687F21F:
    Type: AWS::AppSync::DataSource
    Properties:
      ApiId:
        Fn::GetAtt:
          - EnvironmentApiD8145510
          - ApiId
      DynamoDBConfig:
        AwsRegion:
          Ref: AWS::Region
        TableName:
          Ref: EnvironmentTrackingTable97AE1FE4
      Name: TrackingTableDataSource
      ServiceRoleArn:
        Fn::GetAtt:
          - EnvironmentApiTrackingTableDataSourceServiceRoleD7C6E0FC
          - Arn
      Type: AMAZON_DYNAMODB
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiCreateDocumentResolverCB5779B6:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId:
        Fn::GetAtt:
          - EnvironmentApiD8145510
          - ApiId
      DataSourceName: TrackingTableDataSource
      FieldName: createDocument
      Kind: UNIT
      RequestMappingTemplate:
        Fn::Join:
          - ""
          - - |-2
              
                        #set( $PK = "doc#${ctx.args.input.ObjectKey}" )
                
                        #set( $shardsInDay = 6 )
                        #set( $shardDivider = 24 / $shardsInDay )
                        #set( $Integer = 0 )
                        #set( $now = $ctx.args.input.QueuedTime )
                        #set( $date = $now.substring(0, 10) )
                        #set( $hourString = $now.substring(11, 13) )
                        #set( $hour = $Integer.parseInt($hourString) )
                        #set( $hourShard = $hour / $shardDivider )
                        #set( $shardPad = $date.format("%02d", $hourShard) )
                        #set( $listPk = "list#${date}#s#${shardPad}" )
                        #set( $listSk = "ts#${now}#id#${ctx.args.input.ObjectKey}" )
                
                        {
                          "version" : "2018-05-29",
                          "operation" : "TransactWriteItems",
                          "transactItems": [
                            {
                              "table": "
            - Ref: EnvironmentTrackingTable97AE1FE4
            - |-
              ",
                              "operation": "PutItem",
                              "key" : {
                                "PK": $util.dynamodb.toDynamoDBJson($PK),
                                "SK": $util.dynamodb.toDynamoDBJson("none"),
                              },
                              "attributeValues": $util.dynamodb.toMapValuesJson($ctx.args.input),
                            },
                            {
                              "table": "
            - Ref: EnvironmentTrackingTable97AE1FE4
            - |-
              ",
                              "operation": "PutItem",
                              "key" : {
                                "PK": $util.dynamodb.toDynamoDBJson($listPk),
                                "SK": $util.dynamodb.toDynamoDBJson($listSk),
                              },
                              "attributeValues": {
                                "ObjectKey": $util.dynamodb.toDynamoDBJson($ctx.args.input.ObjectKey),
                                "QueuedTime": $util.dynamodb.toDynamoDBJson($ctx.args.input.QueuedTime),
                                "ExpiresAfter": $util.dynamodb.toDynamoDBJson($ctx.args.input.ExpiresAfter),
                              },
                            },
                          ],
                        }
      ResponseMappingTemplate: |-2
        
                  #if($ctx.error)
                    $util.error($ctx.error.message, $ctx.error.type)
                  #end
                  $util.toJson({"ObjectKey": $ctx.args.input.ObjectKey})
      TypeName: Mutation
    DependsOn:
      - EnvironmentApiSchemaCED14B43
      - EnvironmentApiTrackingTableDataSource3687F21F
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiUpdateDocumentResolver1BA3B62F:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId:
        Fn::GetAtt:
          - EnvironmentApiD8145510
          - ApiId
      DataSourceName: TrackingTableDataSource
      FieldName: updateDocument
      Kind: UNIT
      RequestMappingTemplate: |-2
        
                #set( $PK = "doc#${ctx.args.input.ObjectKey}" )
                #set( $expNames = {} )
                #set( $expValues = {} )
                #set( $expSet = {} )
                ## Iterate through each argument with values and update expression variables **
                #foreach( $entry in $ctx.args.input.entrySet() )
                    ## skip empty values **
                    #if( !$util.isNullOrBlank($entry.value)  )
                        $util.qr( $expSet.put("#${entry.key}", ":${entry.key}") )
                        $util.qr( $expNames.put("#${entry.key}", "${entry.key}") )
                        $util.qr( $expValues.put(":${entry.key}", $util.dynamodb.toDynamoDB($entry.value)) )
                    #end
                #end
                ## Start building the update expression, starting with attributes we're going to SET **
                #set( $expression = "" )
                #if( !${expSet.isEmpty()} )
                    #set( $expression = "SET" )
                    #foreach( $entry in $expSet.entrySet() )
                        #set( $expression = "${expression} ${entry.key} = ${entry.value}" )
                        #if ( $foreach.hasNext )
                            #set( $expression = "${expression}," )
                        #end
                    #end
                #end
                {
                    "version" : "2018-05-29",
                    "operation" : "UpdateItem",
                    "key" : {
                      "PK": $util.dynamodb.toDynamoDBJson($PK),
                      "SK": $util.dynamodb.toDynamoDBJson("none"),
                    },
                    "update" : {
                        "expression": "$expression"
                        #if( !${expNames.isEmpty()} )
                        , "expressionNames": $utils.toJson($expNames)
                        #end
                        #if( !${expValues.isEmpty()} )
                        , "expressionValues": $utils.toJson($expValues)
                        #end
                    }
                }
      ResponseMappingTemplate: $util.toJson($ctx.result)
      TypeName: Mutation
    DependsOn:
      - EnvironmentApiSchemaCED14B43
      - EnvironmentApiTrackingTableDataSource3687F21F
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiGetDocumentResolverCBE0FF1A:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId:
        Fn::GetAtt:
          - EnvironmentApiD8145510
          - ApiId
      DataSourceName: TrackingTableDataSource
      FieldName: getDocument
      Kind: UNIT
      RequestMappingTemplate: |-2
        
                #set( $PK = "doc#${context.arguments.ObjectKey}" )
                {
                  "version": "2018-05-29",
                  "operation": "GetItem",
                  "key" : {
                    "PK": $util.dynamodb.toDynamoDBJson($PK),
                    "SK": $util.dynamodb.toDynamoDBJson("none"),
                  }
                }
      ResponseMappingTemplate: $util.toJson($ctx.result)
      TypeName: Query
    DependsOn:
      - EnvironmentApiSchemaCED14B43
      - EnvironmentApiTrackingTableDataSource3687F21F
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiListDocumentResolver9B7D4CD4:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId:
        Fn::GetAtt:
          - EnvironmentApiD8145510
          - ApiId
      DataSourceName: TrackingTableDataSource
      FieldName: listDocuments
      Kind: UNIT
      RequestMappingTemplate: |-2
        
                {
                    "version": "2018-05-29",
                    "operation": "Scan",
                    "filter": {
                        #if($context.arguments.startDateTime && $context.arguments.endDateTime)
                            "expression": "InitialEventTime BETWEEN :startDateTime AND :endDateTime",
                            "expressionValues": {
                                ":startDateTime": { "S": "$context.arguments.startDateTime" },
                                ":endDateTime": { "S": "$context.arguments.endDateTime" }
                            }
                        #elseif($context.arguments.startDateTime)
                            "expression": "InitialEventTime >= :startDateTime",
                            "expressionValues": {
                                ":startDateTime": { "S": "$context.arguments.startDateTime" }
                            }
                        #elseif($context.arguments.endDateTime)
                            "expression": "InitialEventTime <= :endDateTime",
                            "expressionValues": {
                                ":endDateTime": { "S": "$context.arguments.endDateTime" }
                            }
                        #end
                    },
                    #if($context.prev.result)
                        "nextToken": "$context.prev.result.nextToken",
                    #end
                    "limit": 50,
                    "consistentRead": false,
                    "select": "ALL_ATTRIBUTES"
                }
      ResponseMappingTemplate: |-2
        
                    {
                        "Documents": $util.toJson($ctx.result.items),
                        "nextToken": $util.toJson($ctx.result.nextToken)
                    }
      TypeName: Query
    DependsOn:
      - EnvironmentApiSchemaCED14B43
      - EnvironmentApiTrackingTableDataSource3687F21F
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiListDocumentDateHourResolver719567C5:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId:
        Fn::GetAtt:
          - EnvironmentApiD8145510
          - ApiId
      DataSourceName: TrackingTableDataSource
      FieldName: listDocumentsDateHour
      Kind: UNIT
      RequestMappingTemplate: |-
        #set( $shardsInDay = 6 )
                #set( $shardDivider = 24 / $shardsInDay )
                #set( $Integer = 0 )
                #set( $now = $util.time.nowISO8601() )
                #set( $hourNow = $Integer.parseInt($now.substring(11, 13)) )
                #set( $date = $util.defaultIfNullOrBlank($ctx.args.date, $now.substring(0, 10)) )
                #set( $hour = $util.defaultIfNull($ctx.args.hour, $hourNow) )
                #if( $hour < 0 || $hour > 23 )
                  $util.error("Invalid hour parameter - value should be between 0 and 23")
                #end
                #set( $hourPad = $date.format("%02d", $hour) )
                #set( $hourShard = $hour / $shardDivider )
                #set( $shardPad = $date.format("%02d", $hourShard) )

                #set( $PK = "list#${date}#s#${shardPad}" )
                #set( $skPrefix = "ts#${date}T${hourPad}" )

                {
                  "version" : "2018-05-29",
                  "operation" : "Query",
                  "query" : {
                    "expression": "PK = :PK and begins_with(SK, :prefix)",
                    "expressionValues": {
                      ":PK": $util.dynamodb.toDynamoDBJson($PK),
                      ":prefix": $util.dynamodb.toDynamoDBJson($skPrefix),
                    },
                  },
                }
      ResponseMappingTemplate: |-
        {
                    "Documents": $util.toJson($ctx.result.items),
                    "nextToken": $util.toJson($ctx.result.nextToken)
                }
      TypeName: Query
    DependsOn:
      - EnvironmentApiSchemaCED14B43
      - EnvironmentApiTrackingTableDataSource3687F21F
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentApiListDocumentDateShardResolver8DE3AEE0:
    Type: AWS::AppSync::Resolver
    Properties:
      ApiId:
        Fn::GetAtt:
          - EnvironmentApiD8145510
          - ApiId
      DataSourceName: TrackingTableDataSource
      FieldName: listDocumentsDateShard
      Kind: UNIT
      RequestMappingTemplate: |-
        #set( $shardsInDay = 6 )
                #set( $shardDivider = 24 / $shardsInDay )
                #set( $Integer = 0 )
                #set( $now = $util.time.nowISO8601() )
                #set( $hourNow = $Integer.parseInt($now.substring(11, 13)) )
                #set( $shardNow = $hourNow / $shardDivider )
                #set( $date = $util.defaultIfNullOrBlank($ctx.args.date, $now.substring(0, 10)) )
                #set( $shard = $util.defaultIfNull($ctx.args.shard, $shardNow) )
                #if( $shard >= $shardsInDay )
                  $util.error("Invalid shard parameter value - must positive and less than ${shardsInDay}")
                #end
                #set( $hourShard = $hour / $shardDivider )
                #set( $shardPad = $date.format("%02d", $shard) )

                #set( $PK = "list#${date}#s#${shardPad}" )

                {
                  "version" : "2018-05-29",
                  "operation" : "Query",
                  "query" : {
                    "expression": "PK = :PK",
                    "expressionValues": {
                      ":PK": $util.dynamodb.toDynamoDBJson($PK),
                    }
                  }
                }
      ResponseMappingTemplate: |-
        {
                    "Documents": $util.toJson($ctx.result.items),
                    "nextToken": $util.toJson($ctx.result.nextToken)
                }
      TypeName: Query
    DependsOn:
      - EnvironmentApiSchemaCED14B43
      - EnvironmentApiTrackingTableDataSource3687F21F
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentTrackingTable97AE1FE4:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: PK
          AttributeType: S
        - AttributeName: SK
          AttributeType: S
      KeySchema:
        - AttributeName: PK
          KeyType: HASH
        - AttributeName: SK
          KeyType: RANGE
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
      TimeToLiveSpecification:
        AttributeName: ExpiresAfter
        Enabled: true
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentConfigurationTableFFC21CA7:
    Type: AWS::DynamoDB::Table
    Properties:
      AttributeDefinitions:
        - AttributeName: Configuration
          AttributeType: S
      KeySchema:
        - AttributeName: Configuration
          KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentUpdateConfigurationFunctionServiceRole6FF8673E:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentUpdateConfigurationFunctionServiceRoleDefaultPolicyC83238DE:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - dynamodb:BatchGetItem
              - dynamodb:GetRecords
              - dynamodb:GetShardIterator
              - dynamodb:Query
              - dynamodb:GetItem
              - dynamodb:Scan
              - dynamodb:ConditionCheckItem
              - dynamodb:BatchWriteItem
              - dynamodb:PutItem
              - dynamodb:UpdateItem
              - dynamodb:DeleteItem
              - dynamodb:DescribeTable
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - EnvironmentConfigurationTableFFC21CA7
                  - Arn
              - Ref: AWS::NoValue
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - ConfigurationBucketECC78386
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - ConfigurationBucketECC78386
                        - Arn
                    - /*
        Version: "2012-10-17"
      PolicyName: EnvironmentUpdateConfigurationFunctionServiceRoleDefaultPolicyC83238DE
      Roles:
        - Ref: EnvironmentUpdateConfigurationFunctionServiceRole6FF8673E
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentUpdateConfigurationFunctionD5138FA8:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Fn::Sub: cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}
        S3Key: f811d66a6d0a0e573dbaf30da46df731a85f5a43996e7b3b2bd5d43d8b9fd2aa.zip
      Environment:
        Variables:
          CONFIGURATION_TABLE_NAME:
            Ref: EnvironmentConfigurationTableFFC21CA7
      Handler: index.handler
      Role:
        Fn::GetAtt:
          - EnvironmentUpdateConfigurationFunctionServiceRole6FF8673E
          - Arn
      Runtime: python3.12
    DependsOn:
      - EnvironmentUpdateConfigurationFunctionServiceRoleDefaultPolicyC83238DE
      - EnvironmentUpdateConfigurationFunctionServiceRole6FF8673E
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentDocumentQueueDLQAF00F989:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 345600
      VisibilityTimeout: 30
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentDocumentQueue95D3B000:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 86400
      RedrivePolicy:
        deadLetterTargetArn:
          Fn::GetAtt:
            - EnvironmentDocumentQueueDLQAF00F989
            - Arn
        maxReceiveCount: 1000
      VisibilityTimeout: 30
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentQueueSenderDLQ1F4F987B:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 345600
      VisibilityTimeout: 30
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentQueueSenderLogGroup00DE2882:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 7
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentQueueSenderServiceRoleAE73D9E0:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentQueueSenderServiceRoleDefaultPolicy50341F3F:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: sqs:SendMessage
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - EnvironmentQueueSenderDLQ1F4F987B
                - Arn
          - Action:
              - sqs:SendMessage
              - sqs:GetQueueAttributes
              - sqs:GetQueueUrl
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - EnvironmentDocumentQueue95D3B000
                - Arn
          - Action: appsync:GraphQL
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":appsync:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :apis/
                  - Fn::GetAtt:
                      - EnvironmentApiD8145510
                      - ApiId
                  - /types/Mutation/*
        Version: "2012-10-17"
      PolicyName: EnvironmentQueueSenderServiceRoleDefaultPolicy50341F3F
      Roles:
        - Ref: EnvironmentQueueSenderServiceRoleAE73D9E0
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentQueueSender29E9D2B0:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Fn::Sub: cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}
        S3Key: 6de745b96e4bd8dc2c164a44813725bced75404deb28e173265d24963c974666.zip
      DeadLetterConfig:
        TargetArn:
          Fn::GetAtt:
            - EnvironmentQueueSenderDLQ1F4F987B
            - Arn
      Environment:
        Variables:
          LOG_LEVEL: INFO
          QUEUE_URL:
            Ref: EnvironmentDocumentQueue95D3B000
          APPSYNC_API_URL:
            Fn::GetAtt:
              - EnvironmentApiD8145510
              - GraphQLUrl
          DATA_RETENTION_IN_DAYS: "365"
          OUTPUT_BUCKET:
            Ref: OutputBucket7114EB27
      Handler: index.handler
      Layers:
        - Ref: comamazonawscdkcdklabsgenaiidpidpcommonlayer5E5CC073
      LoggingConfig:
        LogGroup:
          Ref: EnvironmentQueueSenderLogGroup00DE2882
      Role:
        Fn::GetAtt:
          - EnvironmentQueueSenderServiceRoleAE73D9E0
          - Arn
      Runtime: python3.12
      Timeout: 30
    DependsOn:
      - EnvironmentQueueSenderServiceRoleDefaultPolicy50341F3F
      - EnvironmentQueueSenderServiceRoleAE73D9E0
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentWorkflowTrackerDLQ233E7165:
    Type: AWS::SQS::Queue
    Properties:
      MessageRetentionPeriod: 345600
      VisibilityTimeout: 30
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentWorkflowTrackerLogGroup26002ADA:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 7
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentWorkflowTrackerServiceRole9CEC777F:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentWorkflowTrackerServiceRoleDefaultPolicy054BF2B3:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: sqs:SendMessage
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - EnvironmentWorkflowTrackerDLQ233E7165
                - Arn
          - Action: cloudwatch:PutMetricData
            Effect: Allow
            Resource: "*"
          - Action: appsync:GraphQL
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":appsync:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :apis/
                  - Fn::GetAtt:
                      - EnvironmentApiD8145510
                      - ApiId
                  - /types/Mutation/*
          - Action:
              - dynamodb:BatchGetItem
              - dynamodb:GetRecords
              - dynamodb:GetShardIterator
              - dynamodb:Query
              - dynamodb:GetItem
              - dynamodb:Scan
              - dynamodb:ConditionCheckItem
              - dynamodb:BatchWriteItem
              - dynamodb:PutItem
              - dynamodb:UpdateItem
              - dynamodb:DeleteItem
              - dynamodb:DescribeTable
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - EnvironmentConcurrencyTableE6976F31
                  - Arn
              - Ref: AWS::NoValue
        Version: "2012-10-17"
      PolicyName: EnvironmentWorkflowTrackerServiceRoleDefaultPolicy054BF2B3
      Roles:
        - Ref: EnvironmentWorkflowTrackerServiceRole9CEC777F
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentWorkflowTrackerFC27ADDE:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Fn::Sub: cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}
        S3Key: 2e2e88443e9b0a3aa42ffc03b8725504167b5db80a855a931fd9f459b14e4e70.zip
      DeadLetterConfig:
        TargetArn:
          Fn::GetAtt:
            - EnvironmentWorkflowTrackerDLQ233E7165
            - Arn
      Environment:
        Variables:
          CONCURRENCY_TABLE:
            Ref: EnvironmentConcurrencyTableE6976F31
          METRIC_NAMESPACE: Pattern2TestStack
          APPSYNC_API_URL:
            Fn::GetAtt:
              - EnvironmentApiD8145510
              - GraphQLUrl
          OUTPUT_BUCKET:
            Ref: OutputBucket7114EB27
      Handler: index.handler
      Layers:
        - Ref: comamazonawscdkcdklabsgenaiidpidpcommonlayer5E5CC073
      LoggingConfig:
        LogGroup:
          Ref: EnvironmentWorkflowTrackerLogGroup26002ADA
      Role:
        Fn::GetAtt:
          - EnvironmentWorkflowTrackerServiceRole9CEC777F
          - Arn
      Runtime: python3.12
      Timeout: 30
    DependsOn:
      - EnvironmentWorkflowTrackerServiceRoleDefaultPolicy054BF2B3
      - EnvironmentWorkflowTrackerServiceRole9CEC777F
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentLookupFunctionLogGroup0CA6EDAD:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 7
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentLookupFunctionServiceRole35D8AFE5:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentLookupFunctionServiceRoleDefaultPolicyC9624093:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - dynamodb:BatchGetItem
              - dynamodb:GetRecords
              - dynamodb:GetShardIterator
              - dynamodb:Query
              - dynamodb:GetItem
              - dynamodb:Scan
              - dynamodb:ConditionCheckItem
              - dynamodb:DescribeTable
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - EnvironmentTrackingTable97AE1FE4
                  - Arn
              - Ref: AWS::NoValue
          - Action:
              - states:ListExecutions
              - states:ListStateMachines
            Effect: Allow
            Resource:
              Ref: ProcessorDocumentProcessingStateMachineE572AD61
          - Action:
              - states:DescribeExecution
              - states:DescribeStateMachineForExecution
              - states:GetExecutionHistory
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":states:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - ":execution:"
                  - Fn::Select:
                      - 6
                      - Fn::Split:
                          - ":"
                          - Ref: ProcessorDocumentProcessingStateMachineE572AD61
                  - :*
          - Action:
              - states:ListActivities
              - states:DescribeStateMachine
              - states:DescribeActivity
            Effect: Allow
            Resource: "*"
        Version: "2012-10-17"
      PolicyName: EnvironmentLookupFunctionServiceRoleDefaultPolicyC9624093
      Roles:
        - Ref: EnvironmentLookupFunctionServiceRole35D8AFE5
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  EnvironmentLookupFunction9061F580:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Fn::Sub: cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}
        S3Key: d287053aa1319009bd3ebbd7ec71233821e8676b6b9fd7ad114573073183452d.zip
      Environment:
        Variables:
          TRACKING_TABLE:
            Ref: EnvironmentTrackingTable97AE1FE4
      Handler: index.handler
      LoggingConfig:
        LogGroup:
          Ref: EnvironmentLookupFunctionLogGroup0CA6EDAD
      Role:
        Fn::GetAtt:
          - EnvironmentLookupFunctionServiceRole35D8AFE5
          - Arn
      Runtime: python3.12
      Timeout: 30
    DependsOn:
      - EnvironmentLookupFunctionServiceRoleDefaultPolicyC9624093
      - EnvironmentLookupFunctionServiceRole35D8AFE5
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  comamazonawscdkcdklabsgenaiidpidpcommonlayer5E5CC073:
    Type: AWS::Lambda::LayerVersion
    Properties:
      CompatibleRuntimes:
        - python3.12
      Content:
        S3Bucket:
          Fn::Sub: cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}
        S3Key: 14cba1192916cdf324a42f0e4b0cbfe316bde3c08e33b33cf86f79a70bcf91d3.zip
      Description: Lambda Layer containing the idp_common Python package
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorOCRFunctionLogGroupA3730DF6:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 7
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorOCRFunctionServiceRole0DD1F23F:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorOCRFunctionServiceRoleDefaultPolicy02FACBEC:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - InputBucket3BF8630A
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - InputBucket3BF8630A
                        - Arn
                    - /*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject
              - s3:PutObjectLegalHold
              - s3:PutObjectRetention
              - s3:PutObjectTagging
              - s3:PutObjectVersionTagging
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - OutputBucket7114EB27
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - OutputBucket7114EB27
                        - Arn
                    - /*
          - Action: cloudwatch:PutMetricData
            Effect: Allow
            Resource: "*"
          - Action:
              - dynamodb:BatchGetItem
              - dynamodb:GetRecords
              - dynamodb:GetShardIterator
              - dynamodb:Query
              - dynamodb:GetItem
              - dynamodb:Scan
              - dynamodb:ConditionCheckItem
              - dynamodb:BatchWriteItem
              - dynamodb:PutItem
              - dynamodb:UpdateItem
              - dynamodb:DeleteItem
              - dynamodb:DescribeTable
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - EnvironmentConfigurationTableFFC21CA7
                  - Arn
              - Ref: AWS::NoValue
          - Action: appsync:GraphQL
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":appsync:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :apis/
                  - Fn::GetAtt:
                      - EnvironmentApiD8145510
                      - ApiId
                  - /types/Mutation/*
          - Action:
              - textract:DetectDocumentText
              - textract:AnalyzeDocument
            Effect: Allow
            Resource: "*"
        Version: "2012-10-17"
      PolicyName: ProcessorOCRFunctionServiceRoleDefaultPolicy02FACBEC
      Roles:
        - Ref: ProcessorOCRFunctionServiceRole0DD1F23F
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorOCRFunction414FD34F:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Fn::Sub: cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}
        S3Key: 04990cd2a21a03b23cc0bb449cd4a4b24ee926eae8d2aff06046a7b29ba94ff8.zip
      Environment:
        Variables:
          METRIC_NAMESPACE: Pattern2TestStack
          MAX_WORKERS: "20"
          CONFIGURATION_TABLE_NAME:
            Ref: EnvironmentConfigurationTableFFC21CA7
          LOG_LEVEL: INFO
          APPSYNC_API_URL:
            Fn::GetAtt:
              - EnvironmentApiD8145510
              - GraphQLUrl
      Handler: index.handler
      Layers:
        - Ref: comamazonawscdkcdklabsgenaiidpidpcommonlayer5E5CC073
      LoggingConfig:
        LogGroup:
          Ref: ProcessorOCRFunctionLogGroupA3730DF6
      MemorySize: 4096
      Role:
        Fn::GetAtt:
          - ProcessorOCRFunctionServiceRole0DD1F23F
          - Arn
      Runtime: python3.12
      Timeout: 900
    DependsOn:
      - ProcessorOCRFunctionServiceRoleDefaultPolicy02FACBEC
      - ProcessorOCRFunctionServiceRole0DD1F23F
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorClassificationFunctionLogGroup5DC4A306:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 7
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorClassificationFunctionServiceRole4F674B16:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorClassificationFunctionServiceRoleDefaultPolicy723C6775:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - InputBucket3BF8630A
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - InputBucket3BF8630A
                        - Arn
                    - /*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject
              - s3:PutObjectLegalHold
              - s3:PutObjectRetention
              - s3:PutObjectTagging
              - s3:PutObjectVersionTagging
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - OutputBucket7114EB27
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - OutputBucket7114EB27
                        - Arn
                    - /*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - ConfigurationBucketECC78386
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - ConfigurationBucketECC78386
                        - Arn
                    - /*
          - Action: cloudwatch:PutMetricData
            Effect: Allow
            Resource: "*"
          - Action:
              - dynamodb:BatchGetItem
              - dynamodb:GetRecords
              - dynamodb:GetShardIterator
              - dynamodb:Query
              - dynamodb:GetItem
              - dynamodb:Scan
              - dynamodb:ConditionCheckItem
              - dynamodb:BatchWriteItem
              - dynamodb:PutItem
              - dynamodb:UpdateItem
              - dynamodb:DeleteItem
              - dynamodb:DescribeTable
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - EnvironmentConfigurationTableFFC21CA7
                  - Arn
              - Ref: AWS::NoValue
          - Action: appsync:GraphQL
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":appsync:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :apis/
                  - Fn::GetAtt:
                      - EnvironmentApiD8145510
                      - ApiId
                  - /types/Mutation/*
          - Action:
              - bedrock:InvokeModel*
              - bedrock:GetFoundationModel
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":bedrock:"
                  - Ref: AWS::Region
                  - ::foundation-model/amazon.nova-pro-v1:0
        Version: "2012-10-17"
      PolicyName: ProcessorClassificationFunctionServiceRoleDefaultPolicy723C6775
      Roles:
        - Ref: ProcessorClassificationFunctionServiceRole4F674B16
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorClassificationFunction37BBC4C8:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Fn::Sub: cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}
        S3Key: 1ee980006b987187064b907a7ad6082d8650a2cfd447a49b9af176efa25884b3.zip
      Environment:
        Variables:
          METRIC_NAMESPACE: Pattern2TestStack
          MAX_WORKERS: "20"
          CONFIGURATION_BUCKET:
            Ref: ConfigurationBucketECC78386
          CONFIGURATION_TABLE_NAME:
            Ref: EnvironmentConfigurationTableFFC21CA7
          LOG_LEVEL: INFO
          APPSYNC_API_URL:
            Fn::GetAtt:
              - EnvironmentApiD8145510
              - GraphQLUrl
      Handler: index.handler
      Layers:
        - Ref: comamazonawscdkcdklabsgenaiidpidpcommonlayer5E5CC073
      LoggingConfig:
        LogGroup:
          Ref: ProcessorClassificationFunctionLogGroup5DC4A306
      MemorySize: 4096
      Role:
        Fn::GetAtt:
          - ProcessorClassificationFunctionServiceRole4F674B16
          - Arn
      Runtime: python3.12
      Timeout: 900
    DependsOn:
      - ProcessorClassificationFunctionServiceRoleDefaultPolicy723C6775
      - ProcessorClassificationFunctionServiceRole4F674B16
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorExtractionFunctionLogGroup5CC69589:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 7
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorExtractionFunctionServiceRole2CBCF541:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorExtractionFunctionServiceRoleDefaultPolicyBB08B846:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - InputBucket3BF8630A
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - InputBucket3BF8630A
                        - Arn
                    - /*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject
              - s3:PutObjectLegalHold
              - s3:PutObjectRetention
              - s3:PutObjectTagging
              - s3:PutObjectVersionTagging
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - OutputBucket7114EB27
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - OutputBucket7114EB27
                        - Arn
                    - /*
          - Action:
              - dynamodb:BatchGetItem
              - dynamodb:GetRecords
              - dynamodb:GetShardIterator
              - dynamodb:Query
              - dynamodb:GetItem
              - dynamodb:Scan
              - dynamodb:ConditionCheckItem
              - dynamodb:BatchWriteItem
              - dynamodb:PutItem
              - dynamodb:UpdateItem
              - dynamodb:DeleteItem
              - dynamodb:DescribeTable
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - EnvironmentConfigurationTableFFC21CA7
                  - Arn
              - Ref: AWS::NoValue
          - Action: cloudwatch:PutMetricData
            Effect: Allow
            Resource: "*"
          - Action: appsync:GraphQL
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":appsync:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :apis/
                  - Fn::GetAtt:
                      - EnvironmentApiD8145510
                      - ApiId
                  - /types/Mutation/*
          - Action:
              - bedrock:InvokeModel*
              - bedrock:GetFoundationModel
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - :bedrock:*::foundation-model/amazon.nova-pro-v1:0
          - Action:
              - bedrock:GetInferenceProfile
              - bedrock:InvokeModel*
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":bedrock:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :inference-profile/us.amazon.nova-pro-v1:0
        Version: "2012-10-17"
      PolicyName: ProcessorExtractionFunctionServiceRoleDefaultPolicyBB08B846
      Roles:
        - Ref: ProcessorExtractionFunctionServiceRole2CBCF541
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorExtractionFunction19224B4C:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Fn::Sub: cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}
        S3Key: 6c1f3586fbcb4a03183f52bfda878b1748caf940dadbdd4f19da1e31fd1f6bfb.zip
      Environment:
        Variables:
          EXTRACTION_MODEL_ID: us.amazon.nova-pro-v1:0
          METRIC_NAMESPACE: Pattern2TestStack
          CONFIGURATION_TABLE_NAME:
            Ref: EnvironmentConfigurationTableFFC21CA7
          GUARDRAIL_ID_AND_VERSION: ""
          LOG_LEVEL: INFO
          APPSYNC_API_URL:
            Fn::GetAtt:
              - EnvironmentApiD8145510
              - GraphQLUrl
      Handler: index.handler
      Layers:
        - Ref: comamazonawscdkcdklabsgenaiidpidpcommonlayer5E5CC073
      LoggingConfig:
        LogGroup:
          Ref: ProcessorExtractionFunctionLogGroup5CC69589
      MemorySize: 512
      Role:
        Fn::GetAtt:
          - ProcessorExtractionFunctionServiceRole2CBCF541
          - Arn
      Runtime: python3.12
      Timeout: 900
    DependsOn:
      - ProcessorExtractionFunctionServiceRoleDefaultPolicyBB08B846
      - ProcessorExtractionFunctionServiceRole2CBCF541
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorProcessResultsFunctionLogGroup97482ABB:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 7
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorProcessResultsFunctionServiceRole48003B80:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorProcessResultsFunctionServiceRoleDefaultPolicyD6F66386:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - InputBucket3BF8630A
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - InputBucket3BF8630A
                        - Arn
                    - /*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject
              - s3:PutObjectLegalHold
              - s3:PutObjectRetention
              - s3:PutObjectTagging
              - s3:PutObjectVersionTagging
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - OutputBucket7114EB27
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - OutputBucket7114EB27
                        - Arn
                    - /*
          - Action: cloudwatch:PutMetricData
            Effect: Allow
            Resource: "*"
          - Action: appsync:GraphQL
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":appsync:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :apis/
                  - Fn::GetAtt:
                      - EnvironmentApiD8145510
                      - ApiId
                  - /types/Mutation/*
        Version: "2012-10-17"
      PolicyName: ProcessorProcessResultsFunctionServiceRoleDefaultPolicyD6F66386
      Roles:
        - Ref: ProcessorProcessResultsFunctionServiceRole48003B80
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorProcessResultsFunction8FE8FC80:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Fn::Sub: cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}
        S3Key: aadbbae2473d98852fe81333f8ead39b3f6c726d9e8f66d4f00780dfdab8a2fc.zip
      Environment:
        Variables:
          METRIC_NAMESPACE: Pattern2TestStack
          LOG_LEVEL: INFO
          APPSYNC_API_URL:
            Fn::GetAtt:
              - EnvironmentApiD8145510
              - GraphQLUrl
      Handler: index.handler
      Layers:
        - Ref: comamazonawscdkcdklabsgenaiidpidpcommonlayer5E5CC073
      LoggingConfig:
        LogGroup:
          Ref: ProcessorProcessResultsFunctionLogGroup97482ABB
      MemorySize: 4096
      Role:
        Fn::GetAtt:
          - ProcessorProcessResultsFunctionServiceRole48003B80
          - Arn
      Runtime: python3.12
      Timeout: 900
    DependsOn:
      - ProcessorProcessResultsFunctionServiceRoleDefaultPolicyD6F66386
      - ProcessorProcessResultsFunctionServiceRole48003B80
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorSummarizationFunctionLogGroup7DFE16FD:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 7
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorSummarizationFunctionServiceRole3E239093:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorSummarizationFunctionServiceRoleDefaultPolicy3749DACA:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - InputBucket3BF8630A
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - InputBucket3BF8630A
                        - Arn
                    - /*
          - Action:
              - s3:GetObject*
              - s3:GetBucket*
              - s3:List*
              - s3:DeleteObject*
              - s3:PutObject
              - s3:PutObjectLegalHold
              - s3:PutObjectRetention
              - s3:PutObjectTagging
              - s3:PutObjectVersionTagging
              - s3:Abort*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - OutputBucket7114EB27
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - OutputBucket7114EB27
                        - Arn
                    - /*
          - Action:
              - dynamodb:BatchGetItem
              - dynamodb:GetRecords
              - dynamodb:GetShardIterator
              - dynamodb:Query
              - dynamodb:GetItem
              - dynamodb:Scan
              - dynamodb:ConditionCheckItem
              - dynamodb:BatchWriteItem
              - dynamodb:PutItem
              - dynamodb:UpdateItem
              - dynamodb:DeleteItem
              - dynamodb:DescribeTable
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - EnvironmentConfigurationTableFFC21CA7
                  - Arn
              - Ref: AWS::NoValue
          - Action:
              - bedrock:InvokeModel*
              - bedrock:GetFoundationModel
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":bedrock:"
                  - Ref: AWS::Region
                  - ::foundation-model/anthropic.claude-3-5-sonnet-20241022-v2:0
          - Action: appsync:GraphQL
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":appsync:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :apis/
                  - Fn::GetAtt:
                      - EnvironmentApiD8145510
                      - ApiId
                  - /types/Mutation/*
        Version: "2012-10-17"
      PolicyName: ProcessorSummarizationFunctionServiceRoleDefaultPolicy3749DACA
      Roles:
        - Ref: ProcessorSummarizationFunctionServiceRole3E239093
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorSummarizationFunction677B39CB:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Fn::Sub: cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}
        S3Key: 4d3889459602fdcbd9cf0b8c7a8e495cddf4813e3e92e2b8ead56109e8328b83.zip
      Environment:
        Variables:
          METRIC_NAMESPACE: Pattern2TestStack
          CONFIGURATION_TABLE_NAME:
            Ref: EnvironmentConfigurationTableFFC21CA7
          GUARDRAIL_ID_AND_VERSION: ""
          LOG_LEVEL: INFO
          APPSYNC_API_URL:
            Fn::GetAtt:
              - EnvironmentApiD8145510
              - GraphQLUrl
      Handler: index.handler
      Layers:
        - Ref: comamazonawscdkcdklabsgenaiidpidpcommonlayer5E5CC073
      LoggingConfig:
        LogGroup:
          Ref: ProcessorSummarizationFunctionLogGroup7DFE16FD
      MemorySize: 4096
      Role:
        Fn::GetAtt:
          - ProcessorSummarizationFunctionServiceRole3E239093
          - Arn
      Runtime: python3.12
      Timeout: 900
    DependsOn:
      - ProcessorSummarizationFunctionServiceRoleDefaultPolicy3749DACA
      - ProcessorSummarizationFunctionServiceRole3E239093
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorStateMachineRole4A225956:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: states.amazonaws.com
        Version: "2012-10-17"
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorStateMachineRoleDefaultPolicy916374A0:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action: lambda:InvokeFunction
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - ProcessorOCRFunction414FD34F
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - ProcessorOCRFunction414FD34F
                        - Arn
                    - :*
          - Action: lambda:InvokeFunction
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - ProcessorClassificationFunction37BBC4C8
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - ProcessorClassificationFunction37BBC4C8
                        - Arn
                    - :*
          - Action: lambda:InvokeFunction
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - ProcessorExtractionFunction19224B4C
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - ProcessorExtractionFunction19224B4C
                        - Arn
                    - :*
          - Action: lambda:InvokeFunction
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - ProcessorProcessResultsFunction8FE8FC80
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - ProcessorProcessResultsFunction8FE8FC80
                        - Arn
                    - :*
          - Action: lambda:InvokeFunction
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - ProcessorSummarizationFunction677B39CB
                  - Arn
              - Fn::Join:
                  - ""
                  - - Fn::GetAtt:
                        - ProcessorSummarizationFunction677B39CB
                        - Arn
                    - :*
          - Action:
              - logs:CreateLogDelivery
              - logs:GetLogDelivery
              - logs:UpdateLogDelivery
              - logs:DeleteLogDelivery
              - logs:ListLogDeliveries
              - logs:PutResourcePolicy
              - logs:DescribeResourcePolicies
              - logs:DescribeLogGroups
            Effect: Allow
            Resource: "*"
        Version: "2012-10-17"
      PolicyName: ProcessorStateMachineRoleDefaultPolicy916374A0
      Roles:
        - Ref: ProcessorStateMachineRole4A225956
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorStateMachineLogGroupEEA206EF:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 7
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorDocumentProcessingStateMachineE572AD61:
    Type: AWS::StepFunctions::StateMachine
    Properties:
      DefinitionS3Location:
        Bucket:
          Fn::Sub: cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}
        Key: 84cbd000d513d8f46639488e9723f91937ae519d1921338013ae4eac76dd5a0e.json
      DefinitionSubstitutions:
        OCRFunctionArn:
          Fn::GetAtt:
            - ProcessorOCRFunction414FD34F
            - Arn
        ClassificationFunctionArn:
          Fn::GetAtt:
            - ProcessorClassificationFunction37BBC4C8
            - Arn
        ExtractionFunctionArn:
          Fn::GetAtt:
            - ProcessorExtractionFunction19224B4C
            - Arn
        ProcessResultsLambdaArn:
          Fn::GetAtt:
            - ProcessorProcessResultsFunction8FE8FC80
            - Arn
        SummarizationLambdaArn:
          Fn::GetAtt:
            - ProcessorSummarizationFunction677B39CB
            - Arn
        IsSummarizationEnabled: "true"
        OutputBucket:
          Ref: OutputBucket7114EB27
      LoggingConfiguration:
        Destinations:
          - CloudWatchLogsLogGroup:
              LogGroupArn:
                Fn::GetAtt:
                  - ProcessorStateMachineLogGroupEEA206EF
                  - Arn
        IncludeExecutionData: true
        Level: ALL
      RoleArn:
        Fn::GetAtt:
          - ProcessorStateMachineRole4A225956
          - Arn
    DependsOn:
      - ProcessorStateMachineRoleDefaultPolicy916374A0
      - ProcessorStateMachineRole4A225956
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorUpdateSchemaConfig4C5D1735:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - EnvironmentUpdateConfigurationFunctionD5138FA8
          - Arn
      Schema:
        type: object
        required:
          - notes
          - classes
          - classification
          - extraction
        properties:
          notes:
            order: 0
            type: string
            description: Notes
          ocr:
            order: 1
            type: object
            sectionLabel: OCR Configuration
            required:
              - features
            properties:
              features:
                type: array
                listLabel: Features
                itemLabel: Feature
                items:
                  type: object
                  required:
                    - name
                  properties:
                    name:
                      type: string
                      description: Feature - select one of the supported OCR feature types
                      enum:
                        - TABLES
                        - FORMS
                        - SIGNATURES
                        - LAYOUT
          classes:
            order: 2
            type: array
            sectionLabel: Class definitions
            listLabel: Classes
            itemLabel: Class
            columns: 2
            items:
              type: object
              required:
                - name
                - description
                - attributes
              properties:
                name:
                  type: string
                  description: Class name
                description:
                  type: string
                  description: Class description
                attributes:
                  type: array
                  listLabel: Attributes
                  itemLabel: Attribute
                  items:
                    type: object
                    required:
                      - name
                      - description
                    properties:
                      name:
                        type: string
                        description: Attribute name
                        order: 0
                      description:
                        type: string
                        description: Attribute description
                        order: 1
                      evaluation_method:
                        type: string
                        description: Evaluation Method
                        enum:
                          - ""
                          - LLM
                          - SEMANTIC
                          - FUZZY
                          - HUNGARIAN
                          - NUMERIC_EXACT
                          - EXACT
                        order: 2
                      hungarian_comparator:
                        type: string
                        description: Comparator type for HUNGARIAN method
                        enum:
                          - EXACT
                          - FUZZY
                          - NUMERIC
                        order: 3
                        dependsOn:
                          field: evaluation_method
                          value: HUNGARIAN
                      evaluation_threshold:
                        type: number
                        description: Evaluation Threshold - used for SEMANTIC, FUZZY, and HUNGARIAN_FUZZY methods
                        minimum: 0
                        maximum: 1
                        order: 4
                        dependsOn:
                          field: evaluation_method
                          values:
                            - SEMANTIC
                            - FUZZY
                            - HUNGARIAN_FUZZY
                    columns: 2
          classification:
            order: 3
            type: object
            sectionLabel: Classification Inference
            required:
              - model
              - temperature
              - top_k
              - system_prompt
              - task_prompt
            properties:
              model:
                type: string
                description: Model identifier
                order: 1
              classificationMethod:
                type: string
                description: Classification methodology to use
                enum:
                  - multimodalPageLevelClassification
                  - textbasedHolisticClassification
                default: textbasedHolisticClassification
                order: 2
              temperature:
                type: number
                minimum: 0
                maximum: 1
                description: Sampling temperature
                order: 3
              top_k:
                type: integer
                minimum: 1
                description: Sampling Top K
                order: 4
              system_prompt:
                type: string
                description: System prompt
                order: 5
              task_prompt:
                type: string
                description: Task prompt - include placeholders {DOCUMENT_TEXT} (replaced by the OCR output), and {CLASS_NAMES_AND_DESCRIPTIONS} (replaced with the class names and descriptions for all specified classes)
                order: 6
          extraction:
            order: 4
            type: object
            format: section
            sectionLabel: Extraction Inference
            required:
              - model
              - temperature
              - top_k
              - system_prompt
              - task_prompt
            properties:
              model:
                type: string
                description: Model identifier
                order: 1
              temperature:
                type: number
                minimum: 0
                maximum: 1
                description: Sampling temperature
                order: 2
              top_k:
                type: integer
                minimum: 1
                description: Sampling Top K
                order: 3
              system_prompt:
                type: string
                description: System prompt
                order: 4
              task_prompt:
                type: string
                description: Task prompt - supports placeholders {DOCUMENT_CLASS} (replaced with the detected class label), {ATTRIBUTE_NAMES_AND_DESCRIPTIONS} (replaced with the attribute names and descriptions for the detected class), and {DOCUMENT_TEXT} (replaced by the OCR output).
                order: 5
          evaluation:
            order: 5
            type: object
            sectionLabel: Evaluation Inference
            properties:
              llm_method:
                type: object
                properties:
                  model:
                    type: string
                    description: Bedrock model ID
                    default: anthropic.claude-3-sonnet-20240229-v1:0
                    order: 1
                  temperature:
                    type: number
                    description: Sampling temperature
                    default: 0
                    order: 2
                  top_k:
                    type: number
                    description: Sampling Top K
                    default: 250
                    order: 3
                  system_prompt:
                    type: string
                    format: textarea
                    description: System prompt for LLM evaluation
                    order: 4
                  task_prompt:
                    type: string
                    format: textarea
                    description: Task prompt for LLM evaluation - supports placeholders {DOCUMENT_CLASS}, {ATTRIBUTE_NAME}, {ATTRIBUTE_DESCRIPTION}, {EXPECTED_VALUE} and {ACTUAL_VALUE}
                    order: 5
          summarization:
            order: 6
            type: object
            sectionLabel: Summarization Inference
            properties:
              model:
                type: string
                description: Bedrock model ID
                order: 1
              temperature:
                type: number
                description: Sampling temperature
                order: 2
              top_k:
                type: number
                description: Sampling Top K
                order: 3
              system_prompt:
                type: string
                format: textarea
                description: System prompt
                order: 4
              task_prompt:
                type: string
                format: textarea
                description: Task prompt - supports parameter {DOCUMENT_TEXT}
                order: 5
          pricing:
            order: 7
            type: array
            sectionLabel: Pricing (Estimates only - check https://aws.amazon.com/bedrock/pricing/ & https://aws.amazon.com/textract/pricing/)
            listLabel: Services
            itemLabel: Service/API
            columns: 2
            items:
              type: object
              required:
                - name
                - units
              properties:
                name:
                  type: string
                  description: Service/API
                units:
                  type: array
                  listLabel: Metered unit pricing
                  itemLabel: Metered Unit price
                  items:
                    type: object
                    required:
                      - name
                      - price
                    properties:
                      name:
                        type: string
                        description: Metered unit name
                      price:
                        type: number
                        description: Estimated cost/unit
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorUpdateDefaultConfigAC8BE482:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken:
        Fn::GetAtt:
          - EnvironmentUpdateConfigurationFunctionD5138FA8
          - Arn
      Default:
        notes: Default settings
        ocr:
          features:
            - name: LAYOUT
            - name: TABLES
            - name: SIGNATURES
        classes:
          - name: letter
            description: A formal written correspondence with sender/recipient addresses, date, salutation, body, and closing signature
            attributes:
              - name: sender_name
                description: The name of the person or entity who wrote or sent the letter. Look for text following or near terms like 'from', 'sender', 'authored by', 'written by', or at the end of the letter before a signature.
              - name: sender_address
                description: The physical address of the sender, typically appearing at the top of the letter. May be labeled as 'address', 'location', or 'from address'.
              - name: recipient_name
                description: The name of the person or entity receiving the letter. Look for this after 'to', 'recipient', 'addressee', or at the beginning of the letter.
              - name: recipient_address
                description: The physical address where the letter is to be delivered. Often labeled as 'to address' or 'delivery address', typically appearing below the recipient name.
              - name: date
                description: The date when the letter was written. Look for a standalone date or text following phrases like 'written on' or 'dated'.
              - name: subject
                description: The topic or main point of the letter. Often preceded by 'subject', 'RE:', or 'regarding'.
              - name: letter_type
                description: The category or classification of the letter, such as 'complaint', 'inquiry', 'invitation', etc. May be indicated by 'type' or 'category'.
              - name: signature
                description: The handwritten name or mark of the sender at the end of the letter. May follow terms like 'signed by' or simply appear at the bottom of the document.
              - name: cc
                description: Names of people who receive a copy of the letter in addition to the main recipient. Often preceded by 'cc', 'carbon copy', or 'copy to'.
              - name: reference_number
                description: An identifying number or code associated with the letter. Look for labels like 'ref', 'reference', or 'our ref'.
          - name: form
            description: A structured document with labeled fields, checkboxes, or blanks requiring user input and completion
            attributes:
              - name: form_type
                description: The category or purpose of the form, such as 'application', 'registration', 'request', etc. May be identified by 'form name', 'document type', or 'form category'.
              - name: form_id
                description: The unique identifier for the form, typically a number or alphanumeric code. Often labeled as 'form number', 'id', or 'reference number'.
              - name: submission_date
                description: The date when the form was submitted or filed. Look for text near 'date', 'submitted on', or 'filed on'.
              - name: submitter_name
                description: The name of the person who submitted the form. May be labeled as 'name', 'submitted by', or 'filed by'.
              - name: submitter_id
                description: An identification number for the person submitting the form, such as social security number, employee ID, etc. Often labeled as 'id number', 'identification', or 'reference'.
              - name: approval_status
                description: The current state of approval for the form, such as 'approved', 'pending', 'rejected', etc. Look for terms like 'status', 'approved', or 'pending'.
              - name: processed_by
                description: The name of the person or department that processed the form. May be indicated by 'processor', 'handled by', or 'approved by'.
              - name: processing_date
                description: The date when the form was processed or completed. Look for labels like 'processed on' or 'completion date'.
              - name: department
                description: The organizational unit responsible for the form. Often abbreviated as 'dept' or may appear as 'department' or 'division'.
              - name: comments
                description: Additional notes or remarks about the form. Look for sections labeled 'notes', 'remarks', or 'comments'.
          - name: invoice
            description: A billing document listing items/services, quantities, prices, payment terms, and transaction totals
            attributes:
              - name: invoice_number
                description: The unique identifier for the invoice. Look for 'invoice no', 'invoice
              - name: invoice_date
                description: The date when the invoice was issued. May be labeled as 'date', 'invoice date', or 'billing date'.
              - name: due_date
                description: The deadline by which payment must be made. Look for 'due date', 'payment due', or 'payable by'.
              - name: vendor_name
                description: The name of the business providing goods or services. May be labeled as 'vendor', 'seller', 'supplier', or simply appear prominently at the top of the invoice.
              - name: vendor_address
                description: The physical location of the vendor. Look for 'address', 'location', or 'business address', typically near the vendor name.
              - name: customer_name
                description: The name of the person or entity being billed. Often preceded by 'customer', 'buyer', or 'bill to'.
              - name: customer_address
                description: The address where the invoice is sent or goods are delivered. May be labeled as 'billing address' or 'ship to'.
              - name: items
                description: Descriptions of the products or services provided. Look for a section with 'description', 'item details', or 'products', usually in a table format.
              - name: quantities
                description: The number of each item provided. Often abbreviated as 'qty' or may appear as 'quantity' or 'amount' in a table column.
              - name: unit_prices
                description: The cost per unit of each item. May be labeled as 'price', 'rate', or 'unit cost'.
              - name: subtotal
                description: The sum of all items before tax and other charges. Look for 'subtotal' or 'net amount', typically found toward the bottom of the invoice.
              - name: tax
                description: The amount of tax charged on the invoice. May be labeled as 'tax', 'VAT', or 'GST', usually appearing after the subtotal.
              - name: total_amount
                description: The final amount to be paid including all charges. Look for 'total', 'grand total', or 'amount due', typically the last figure on the invoice.
              - name: payment_terms
                description: The conditions under which payment should be made, such as '30 days', 'COD', etc. Often labeled as 'terms', 'payment terms', or 'conditions'.
              - name: po_number
                description: The purchase order reference number. May be abbreviated as 'PO' or appear as 'purchase order' or 'order reference'.
          - name: resume
            description: A professional summary showcasing work experience, education, skills, and achievements for job applications
            attributes:
              - name: full_name
                description: The complete name of the job applicant, typically appearing prominently at the top of the resume. May be simply labeled as 'name' or 'applicant name'.
              - name: contact_info
                description: The phone number, email, and address of the applicant. Look for a section with 'contact', 'phone', 'email', or 'address', usually near the top of the resume.
              - name: objective
                description: A statement outlining the applicant's career goals. May be labeled as 'objective', 'summary', or 'profile', typically appearing early in the resume.
              - name: education
                description: The academic history and qualifications of the applicant. Look for a section with 'education', 'academic background', or 'qualifications'.
              - name: experience
                description: The work history and previous roles of the applicant. Often labeled as 'experience', 'work history', or 'employment'.
              - name: skills
                description: The abilities and competencies of the applicant. Look for a section titled 'skills', 'competencies', or 'expertise'.
              - name: certifications
                description: Professional credentials and qualifications. May be labeled as 'certifications', 'certificates', or 'credentials'.
              - name: languages
                description: Languages known and level of proficiency. Often appears in a section labeled 'languages' or 'language proficiency'.
              - name: references
                description: People who can vouch for the applicant's abilities. Look for 'references' or 'referees', typically at the end of the resume.
              - name: achievements
                description: Notable accomplishments and recognition. May be labeled as 'achievements', 'accomplishments', or 'awards'.
          - name: scientific_publication
            description: A peer-reviewed academic document with abstract, methodology, results, citations, and research findings
            attributes:
              - name: title
                description: The name of the scientific paper, typically appearing prominently at the beginning. May be labeled as 'title', 'paper title', or 'article title'.
              - name: authors
                description: The researchers who conducted the study and wrote the paper. Look for names after 'authors', 'contributors', or 'researchers', usually following the title.
              - name: abstract
                description: A brief summary of the paper's content. Often labeled as 'abstract' or 'summary', appearing before the main text.
              - name: keywords
                description: Terms that represent the core topics of the paper. Look for a list labeled 'keywords' or 'key terms', typically after the abstract.
              - name: publication_date
                description: The date when the paper was published. May be preceded by 'published' or labeled as 'publication date'.
              - name: journal_name
                description: The name of the journal where the paper was published. Look for text following 'journal' or 'publication'.
              - name: volume
                description: The volume number of the journal. Often abbreviated as 'vol' or may appear as 'volume'.
              - name: issue
                description: The issue number of the journal. May be labeled as 'issue' or abbreviated as 'no'.
              - name: pages
                description: The page range of the paper in the journal. Often abbreviated as 'pp' or may appear as 'pages'.
              - name: doi
                description: The Digital Object Identifier for the paper, a unique alphanumeric string. Look for 'DOI' or 'digital object identifier'.
              - name: funding
                description: Financial support received for the research. May be indicated by 'funding', 'grants', or 'financial support'.
              - name: corresponding_author
                description: The author responsible for communication regarding the paper. Look for 'corresponding author' or 'contact author'.
              - name: institutions
                description: The organizations with which the authors are affiliated. May be labeled as 'affiliations' or 'institutions'.
          - name: memo
            description: An internal business communication with TO/FROM/DATE/SUBJECT headers for organizational announcements or directives
            attributes:
              - name: memo_date
                description: The date when the memo was written. Look for 'date' or 'memo date', typically near the top of the document.
              - name: from
                description: The person or department that wrote the memo. May be labeled as 'from', 'sender', or 'author'.
              - name: to
                description: The intended recipient of the memo. Look for text after 'to', 'recipient', or 'addressee'.
              - name: subject
                description: The topic of the memo. Often preceded by 'subject', 'RE:', or 'regarding'.
              - name: memo_type
                description: The category or classification of the memo, such as 'informational', 'directive', etc. May be indicated by 'type' or 'category'.
              - name: priority
                description: The urgency level of the memo, such as 'urgent', 'high', 'normal', etc. Look for 'priority' or 'urgency'.
              - name: distribution_list
                description: Additional people who receive copies of the memo. May be labeled as 'distribution', 'cc', or 'copy'.
              - name: reference_number
                description: An identifying number or code for the memo. Look for 'reference' or 'ref no'.
              - name: department
                description: The organizational unit issuing the memo. Often abbreviated as 'dept' or may appear as 'department' or 'division'.
              - name: action_required
                description: Steps that should be taken in response to the memo. Look for 'action', 'response needed', or 'next steps'.
          - name: advertisement
            description: A promotional material featuring product images, marketing text, calls-to-action, and branding elements
            attributes:
              - name: product_name
                description: The name of the item or service being advertised. Look for prominently displayed text that could be a 'product', 'item', or 'service' name.
              - name: brand
                description: The company or manufacturer of the product. May be indicated by a logo or text labeled as 'brand', 'company', or 'manufacturer'.
              - name: price
                description: The cost of the product or service. Look for currency symbols or numbers followed by terms like 'price', 'cost', or 'special offer'.
              - name: promotion_details
                description: Information about special deals or discounts. May be introduced with 'promotion', 'offer', or 'deal'.
              - name: validity_period
                description: The timeframe during which the offer is valid. Look for phrases like 'valid until', 'offer ends', or 'expires'.
              - name: contact_info
                description: How to reach the advertiser. May include phone numbers, websites, or addresses following 'contact', 'call', or 'visit'.
              - name: features
                description: Notable qualities or benefits of the product. Often listed under 'features', 'benefits', or 'highlights'.
              - name: terms_conditions
                description: Legal constraints or limitations of the offer. Look for fine print labeled as 'terms', 'conditions', or 'restrictions'.
              - name: call_to_action
                description: What the advertisement encourages the reader to do. Often appears as imperative phrases like 'call now', 'visit today', or 'order now'.
              - name: disclaimer
                description: Legal statements limiting liability or making clarifications. Usually appears as fine print introduced by 'disclaimer' or phrases like 'terms apply' or 'conditions apply'.
          - name: email
            description: A digital message with email headers (To/From/Subject), timestamps, and conversational threading
            attributes:
              - name: from_address
                description: The email address of the sender. Look for text following 'from', 'sender', or 'sent by', typically at the beginning of the email header.
              - name: to_address
                description: The email address of the primary recipient. May be labeled as 'to', 'recipient', or 'sent to'.
              - name: cc_address
                description: Email addresses of additional recipients who receive copies. Look for 'cc' or 'carbon copy' followed by one or more email addresses.
              - name: bcc_address
                description: Email addresses of hidden recipients. May be labeled as 'bcc' or 'blind copy'.
              - name: subject
                description: The topic of the email. Often preceded by 'subject', 'RE:', or 'regarding'.
              - name: date_sent
                description: The date and time when the email was sent. Look for 'date', 'sent on', or 'received', typically in the email header.
              - name: attachments
                description: Files included with the email. May be indicated by 'attached', 'attachment', or 'enclosed', often with icons or file names.
              - name: priority
                description: The urgency level of the email, such as 'high', 'normal', etc. Look for 'priority' or 'importance'.
              - name: thread_id
                description: An identifier for the email conversation. May be labeled as 'thread' or 'conversation', typically not visible to regular users.
              - name: message_id
                description: A unique identifier for the specific email. Look for 'message id' or 'email id', usually hidden in the email metadata.
          - name: questionnaire
            description: A survey instrument containing numbered questions with multiple choice, rating scales, or open-ended responses
            attributes:
              - name: form_title
                description: The name or title of the questionnaire. Look for prominently displayed text at the beginning that could be a 'title', 'survey name', or 'questionnaire name'.
              - name: respondent_info
                description: Information about the person completing the questionnaire. May include fields labeled 'respondent', 'participant', or 'name'.
              - name: submission_date
                description: The date when the questionnaire was completed. Look for 'date', 'completed on', or 'submitted'.
              - name: section_headers
                description: Titles for different segments of the questionnaire. Often appear as bold or larger text introducing a new 'section', 'part', or 'segment'.
              - name: question_types
                description: The format of questions (multiple choice, free text, etc.). May be indicated by 'type', 'question format', or 'response format'.
              - name: response_options
                description: Possible answers for multiple-choice questions. Look for checkboxes, radio buttons, or dropdown menus with 'options', 'choices', or 'answers'.
              - name: required_fields
                description: Questions that must be answered to complete the questionnaire. Often marked with an asterisk (*) or explicitly labeled as 'required', 'mandatory', or 'must answer'.
              - name: instructions
                description: Guidance on how to complete the questionnaire. Look for text introduced by 'instructions', 'directions', or 'guidelines'.
              - name: survey_id
                description: A unique identifier for the questionnaire. May be labeled as 'survey id', 'reference number', or 'form id'.
              - name: completion_status
                description: Whether the questionnaire has been fully completed. Look for indicators of 'status', 'completion', or 'progress', often shown as a percentage or progress bar.
              - name: Phone Call Representative Courtesy
                description: Measures the perceived politeness and professionalism of the customer service representative during the phone interaction. Checkbox selection on the satisfaction scale with options like "Very Satisfied", "Somewhat Satisfied" etc.
                attributes: []
                evaluation_method: ""
              - name: Phone call representative knowledge rating
                description: Measures the perceived knowledge level of the customer service representative during the phone interaction. Checkbox selection on the satisfaction scale with options like "Very Satisfied", "Somewhat Satisfied" etc.
                attributes: []
              - name: Request handling satisfaction rating
                description: Measures the customer's level of satisfaction with the way their request was handled. Checkbox selection on the satisfaction scale with options like "Very Satisfied", "Somewhat Satisfied" etc.
                attributes: []
              - name: Overall Satisfaction rating
                description: This rating BEST describes the way the customer feels about the representative's response to their request for asssistance. Checkbox selection on the satisfaction scale with options like "I was very satisfied", "I was somewhat satisfied" etc.
                attributes: []
              - name: Future purchase intent
                description: A measure of whether the user will continue to buy the product they contacted about. Checkbox selection with options like "I definitely would", "I probably would" etc.
                attributes: []
              - name: Product recommendation intent
                description: A measure of whether the caller is willing to recommend the product that they called about to others. Checkbox selection with options like "I definitely would", "I probably would" etc.
                attributes: []
          - name: specification
            description: A technical document detailing precise requirements, measurements, standards, and implementation criteria
            attributes:
              - name: product_name
                description: The name of the item being specified. Look for text labeled as 'product', 'item', or 'model', typically appearing prominently at the beginning.
              - name: version
                description: The iteration or release number. May be indicated by 'version', 'revision', or 'release', often followed by a number or code.
              - name: technical_details
                description: Specific characteristics and capabilities. Look for sections labeled 'specifications', 'tech specs', or 'details', often presented in a detailed list.
              - name: requirements
                description: Necessary conditions or resources. May be introduced with 'requirements', 'prerequisites', or 'needed'.
              - name: compatibility
                description: What the product can work with. Look for text following 'compatible with', 'works with', or 'supports'.
              - name: dimensions
                description: Physical measurements of the product. Often labeled as 'dimensions', 'size', or 'measurements', usually including length, width, height, etc.
              - name: materials
                description: What the product is made from. May be indicated by 'materials', 'composition', or phrases like 'made from'.
              - name: standards
                description: Industry guidelines or certifications met. Look for references to 'standards', 'certifications', or 'compliance'.
              - name: revision_history
                description: Record of changes to the specification. Often labeled as 'revisions', 'changes', or 'updates', typically in a table format.
              - name: approval_info
                description: Details about who has validated the specification. May be indicated by phrases like 'approved by', 'certified by', or 'validated'.
          - name: generic
            description: An unstructured document lacking distinctive formatting or purpose-specific elements of other categories
            attributes:
              - name: document_type
                description: The classification or category of the document. Look for terms like 'type', 'category', or 'class' that indicate what kind of document this is.
              - name: document_date
                description: The date when the document was created. May be labeled as 'date', 'created on', or 'issued on'.
              - name: document_id
                description: A unique identifier for the document. Look for 'id', 'reference', or 'number', typically appearing near the top of the document.
              - name: title
                description: The name or heading of the document. Often appears prominently at the beginning, may be labeled as 'title', 'heading', or 'subject'.
              - name: author
                description: The person who created the document. Look for 'author', 'creator', or 'sender'.
              - name: recipient
                description: The person for whom the document is intended. May be indicated by 'recipient', 'to', or 'addressee'.
              - name: content_summary
                description: A brief description of the document's contents. Look for 'summary', 'abstract', or 'overview', typically appearing early in the document.
              - name: status
                description: The current state of the document, such as 'draft', 'final', 'pending', etc. May be labeled as 'status', 'state', or 'condition'.
              - name: department
                description: The organizational unit associated with the document. Often abbreviated as 'dept' or may appear as 'department' or 'division'.
              - name: comments
                description: Additional notes or remarks about the document. Look for sections labeled 'notes', 'remarks', or 'comments'.
        classification:
          top_p: "0.1"
          max_tokens: "4096"
          top_k: "5"
          task_prompt: |-
            <task-description>
            You are a document classification system. Your task is to analyze a document package containing multiple pages and identify distinct document segments, classifying each segment according to the predefined document types provided below.
            </task-description>

            <document-types>
            {CLASS_NAMES_AND_DESCRIPTIONS}
            </document-types>

            <terminology-definitions>
            Key terms used in this task:
            - ordinal_start_page: The one-based beginning page number of a document segment within the document package
            - ordinal_end_page: The one-based ending page number of a document segment within the document package
            - document_type: The document type code detected for a document segment
            - document segment: A continuous range of pages that form a single, complete document
            </terminology-definitions>

            <classification-instructions>
            Follow these steps to classify documents:
            1. Read through the entire document package to understand its contents
            2. Identify page ranges that form complete, distinct documents
            3. Match each document segment to ONE of the document types listed in <document-types>
            4. CRITICAL: Only use document types explicitly listed in the <document-types> section
            5. If a document doesn't clearly match any listed type, assign it to the most similar listed type
            6. Pay special attention to adjacent documents of the same type - they must be separated into distinct segments
            7. Record the ordinal_start_page and ordinal_end_page for each identified segment
            8. Provide appropriate reasons and facts for the predicted document type
            </classification-instructions>

            <document-boundary-rules>
            Rules for determining document boundaries:
            - Content continuity: Pages with continuing paragraphs, numbered sections, or ongoing narratives belong to the same document
            - Visual consistency: Similar layouts, headers, footers, and styling indicate pages belong together
            - Logical structure: Documents typically have clear beginning, middle, and end sections
            - New document indicators: Title pages, cover sheets, or significantly different subject matter signal a new document
            - Topic coherence: Pages discussing the same subject should be grouped together
            - IMPORTANT: Distinct documents of the same type that are adjacent must be separated into different segments
            </document-boundary-rules>

            <output-format>
            Return your classification as valid JSON following this exact structure:
            ```json
            {
                "segments": [
                    {
                        "ordinal_start_page": 1,
                        "ordinal_end_page": 3,
                        "type": "document_type_from_list",
                        "reason": "facts and reasons to classify as the predicted type",
                    },
                    {
                        "ordinal_start_page": 4,
                        "ordinal_end_page": 7,
                        "type": "document_type_from_list"
                        "reason": "facts and reasons to classify as the predicted type",
                    }
                ]
            }
            ```
            </output-format>

            <<CACHEPOINT>>

            <document-text>
            {DOCUMENT_TEXT}
            </document-text>

            <final-instructions>
            Analyze the <document-text> provided above and:
            1. Apply the <classification-instructions> to identify distinct document segments
            2. Use the <document-boundary-rules> to determine where one document ends and another begins
            3. Classify each segment using ONLY the document types from the <document-types> list
            4. Ensure adjacent documents of the same type are separated into distinct segments
            5. Output your classification in the exact JSON format specified in <output-format>
            6. You can get this information from the previous message. Analyze the previous messages to get these instructions.

            Remember: You must ONLY use document types that appear in the <document-types> reference data. Do not invent or create new document types.
            </final-instructions>
          temperature: "0.0"
          model: amazon.nova-pro-v1:0
          system_prompt: You are a document classification expert who can analyze and classify multiple documents and their page boundaries within a document package from various domains. Your task is to determine the document type based on its content and structure, using the provided document type definitions. Your output must be valid JSON according to the requested format.
          classificationMethod: multimodalPageLevelClassification
        extraction:
          top_p: "0.1"
          max_tokens: "4096"
          top_k: "5"
          task_prompt: |-
            <background>
            You are an expert in document analysis and information extraction.  You can understand and extract key information from documents classified as type 
            {DOCUMENT_CLASS}.
            </background>

            <task>
            Your task is to take the unstructured text provided and convert it into a well-organized table format using JSON. Identify the main entities, attributes, or categories mentioned in the attributes list below and use them as keys in the JSON object.  Then, extract the relevant information from the text and populate the corresponding values in the JSON object.
            </task>

            <extraction-guidelines>
            Guidelines:
                1. Ensure that the data is accurately represented and properly formatted within
                the JSON structure
                2. Include double quotes around all keys and values
                3. Do not make up data - only extract information explicitly found in the
                document
                4. Do not use /n for new lines, use a space instead
                5. If a field is not found or if unsure, return null
                6. All dates should be in MM/DD/YYYY format
                7. Do not perform calculations or summations unless totals are explicitly given
                8. If an alias is not found in the document, return null
                9. Guidelines for checkboxes:
                 9.A. CAREFULLY examine each checkbox, radio button, and selection field:
                    - Look for marks like , , x, filled circles (), darkened areas, or handwritten checks indicating selection
                    - For checkboxes and multi-select fields, ONLY INCLUDE options that show clear visual evidence of selection
                    - DO NOT list options that have no visible selection mark
                 9.B. For ambiguous or overlapping tick marks:
                    - If a mark overlaps between two or more checkboxes, determine which option contains the majority of the mark
                    - Consider a checkbox selected if the mark is primarily inside the check box or over the option text
                    - When a mark touches multiple options, analyze which option was most likely intended based on position and density. For handwritten checks, the mark typically flows from the selected checkbox outward.
                    - Carefully analyze visual cues and contextual hints. Think from a human perspective, anticipate natural tendencies, and apply thoughtful reasoning to make the best possible judgment.
                10. Think step by step first and then answer.

            </extraction-guidelines>

            <attributes>
            {ATTRIBUTE_NAMES_AND_DESCRIPTIONS}
            </attributes>

            <<CACHEPOINT>>

            <document-text>
            {DOCUMENT_TEXT}
            </document-text>

            <document_image>
            {DOCUMENT_IMAGE}
            </document_image>

            <final-instructions>
            Extract key information from the document and return a JSON object with the following key steps: 1. Carefully analyze the document text to identify the requested attributes 2. Extract only information explicitly found in the document - never make up data 3. Format all dates as MM/DD/YYYY and replace newlines with spaces 4. For checkboxes, only include options with clear visual selection marks 5. Use null for any fields not found in the document 6. Ensure the output is properly formatted JSON with quoted keys and values 7. Think step by step before finalizing your answer
            </final-instructions>
          temperature: "0.0"
          model: us.amazon.nova-pro-v1:0
          system_prompt: You are a document assistant. Respond only with JSON. Never make up data, only provide data found in the document being provided.
        summarization:
          top_p: "0.1"
          max_tokens: "4096"
          top_k: "5"
          task_prompt: |-
            <document-text>
            {DOCUMENT_TEXT}
            </document-text>
            Analyze the provided document (<document-text>) and create a comprehensive summary.
            CRITICAL INSTRUCTION: You MUST return your response as valid JSON with the EXACT structure shown at the end of these instructions. Do not include any explanations, notes, or text outside of the JSON structure.
            Create a summary that captures the essential information from the document. Your summary should:
            1. Extract key information, main points, and important details
            2. Maintain the original document's organizational structure where appropriate
            3. Preserve important facts, figures, dates, and entities
            4. Reduce the length while retaining all critical information
            5. Use markdown formatting for better readability (headings, lists, emphasis, etc.)
            6. Cite all relevant facts from the source document using inline citations in the format [Cite-X, Page-Y] where X is a sequential citation number and Y is the page number
            7. Format citations as markdown links that reference the full citation list at the bottom of the summary
              Example: [[Cite-1, Page-3]](#cite-1-page-3)

            8. At the end of the summary, include a "References" section that lists all citations with their exact text from the source document in the format:
              [Cite-X, Page-Y]: Exact text from the document

            Output Format:
            You MUST return ONLY valid JSON with the following structure and nothing else:
            ```json {
              "summary": "A comprehensive summary in markdown format with inline citations linked to a references section at the bottom"
            } ```
            Do not include any text, explanations, or notes outside of this JSON structure. The JSON must be properly formatted and parseable.
          temperature: "0.0"
          model: anthropic.claude-3-5-sonnet-20241022-v2:0
          system_prompt: "You are a document summarization expert who can analyze and summarize documents from various domains including medical, financial, legal, and general business documents. Your task is to create a summary that captures the key information, main points, and important details from the document. Your output must be in valid JSON format. \\nSummarization Style: Balanced\\\\nCreate a balanced summary that provides a moderate level of detail. Include the main points and key supporting information, while maintaining the document's overall structure. Aim for a comprehensive yet concise summary.\\n Your output MUST be in valid JSON format with markdown content. You MUST strictly adhere to the output format specified in the instructions."
        evaluation:
          llm_method:
            top_p: "0.1"
            max_tokens: "4096"
            top_k: "5"
            task_prompt: |-
              I need to evaluate attribute extraction for a document of class: {DOCUMENT_CLASS}.

              For the attribute named "{ATTRIBUTE_NAME}" described as "{ATTRIBUTE_DESCRIPTION}":
              - Expected value: {EXPECTED_VALUE}
              - Actual value: {ACTUAL_VALUE}

              Do these values match in meaning, taking into account formatting differences, word order, abbreviations, and semantic equivalence?
              Provide your assessment as a JSON with three fields:
              - "match": boolean (true if they match, false if not)
              - "score": number between 0 and 1 representing the confidence/similarity score
              - "reason": brief explanation of your decision

              Respond ONLY with the JSON and nothing else. Here's the exact format:
              {
                "match": true or false,
                "score": 0.0 to 1.0,
                "reason": "Your explanation here"
              }
            temperature: "0.0"
            model: us.anthropic.claude-3-5-sonnet-20241022-v2:0
            system_prompt: You are an evaluator that helps determine if the predicted and expected values match for document attribute extraction. You will consider the context and meaning rather than just exact string matching.
        pricing:
          - name: textract/detect_document_text
            units:
              - name: pages
                price: "0.0015"
          - name: textract/analyze_document-Layout
            units:
              - name: pages
                price: "0.004"
          - name: textract/analyze_document-Signatures
            units:
              - name: pages
                price: "0.0035"
          - name: textract/analyze_document-Forms
            units:
              - name: pages
                price: "0.05"
          - name: textract/analyze_document-Tables
            units:
              - name: pages
                price: "0.015"
          - name: textract/analyze_document-Tables+Forms
            units:
              - name: pages
                price: "0.065"
          - name: bedrock/us.amazon.nova-lite-v1:0
            units:
              - name: inputTokens
                price: "6.0E-8"
              - name: outputTokens
                price: "2.4E-7"
              - name: cacheReadInputTokens
                price: "1.5E-8"
              - name: cacheWriteInputTokens
                price: "0"
          - name: bedrock/us.amazon.nova-pro-v1:0
            units:
              - name: inputTokens
                price: "8.0E-7"
              - name: outputTokens
                price: "3.2E-6"
              - name: cacheReadInputTokens
                price: "2.0E-7"
              - name: cacheWriteInputTokens
                price: "0"
          - name: bedrock/us.amazon.nova-premier-v1:0
            units:
              - name: inputTokens
                price: "2.5E-6"
              - name: outputTokens
                price: "1.25E-5"
          - name: bedrock/us.anthropic.claude-3-haiku-20240307-v1:0
            units:
              - name: inputTokens
                price: "2.5E-7"
              - name: outputTokens
                price: "1.25E-6"
          - name: bedrock/us.anthropic.claude-3-5-haiku-20241022-v1:0
            units:
              - name: inputTokens
                price: "8.0E-7"
              - name: outputTokens
                price: "4.0E-6"
              - name: cacheReadInputTokens
                price: "8.0E-8"
              - name: cacheWriteInputTokens
                price: "1.0E-6"
          - name: bedrock/us.anthropic.claude-3-5-sonnet-20241022-v2:0
            units:
              - name: inputTokens
                price: "3.0E-6"
              - name: outputTokens
                price: "1.5E-5"
              - name: cacheReadInputTokens
                price: "3.0E-7"
              - name: cacheWriteInputTokens
                price: "3.75E-6"
          - name: bedrock/us.anthropic.claude-3-7-sonnet-20250219-v1:0
            units:
              - name: inputTokens
                price: "3.0E-6"
              - name: outputTokens
                price: "1.5E-5"
              - name: cacheReadInputTokens
                price: "3.0E-7"
              - name: cacheWriteInputTokens
                price: "3.75E-6"
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorQueueProcessorLogGroup4C043267:
    Type: AWS::Logs::LogGroup
    Properties:
      RetentionInDays: 7
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorQueueProcessorServiceRole7E551AE5:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Action: sts:AssumeRole
            Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
        Version: "2012-10-17"
      ManagedPolicyArns:
        - Fn::Join:
            - ""
            - - "arn:"
              - Ref: AWS::Partition
              - :iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorQueueProcessorServiceRoleDefaultPolicy631EF7BF:
    Type: AWS::IAM::Policy
    Properties:
      PolicyDocument:
        Statement:
          - Action:
              - sqs:ReceiveMessage
              - sqs:ChangeMessageVisibility
              - sqs:GetQueueUrl
              - sqs:DeleteMessage
              - sqs:GetQueueAttributes
            Effect: Allow
            Resource:
              Fn::GetAtt:
                - EnvironmentDocumentQueue95D3B000
                - Arn
          - Action: states:StartExecution
            Effect: Allow
            Resource:
              Ref: ProcessorDocumentProcessingStateMachineE572AD61
          - Action: dynamodb:*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - EnvironmentTrackingTable97AE1FE4
                  - Arn
              - Ref: AWS::NoValue
          - Action: dynamodb:*
            Effect: Allow
            Resource:
              - Fn::GetAtt:
                  - EnvironmentConcurrencyTableE6976F31
                  - Arn
              - Ref: AWS::NoValue
          - Action: appsync:GraphQL
            Effect: Allow
            Resource:
              Fn::Join:
                - ""
                - - "arn:"
                  - Ref: AWS::Partition
                  - ":appsync:"
                  - Ref: AWS::Region
                  - ":"
                  - Ref: AWS::AccountId
                  - :apis/
                  - Fn::GetAtt:
                      - EnvironmentApiD8145510
                      - ApiId
                  - /types/Mutation/*
        Version: "2012-10-17"
      PolicyName: ProcessorQueueProcessorServiceRoleDefaultPolicy631EF7BF
      Roles:
        - Ref: ProcessorQueueProcessorServiceRole7E551AE5
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorQueueProcessorF002AD81:
    Type: AWS::Lambda::Function
    Properties:
      Code:
        S3Bucket:
          Fn::Sub: cdk-hnb659fds-assets-${AWS::AccountId}-${AWS::Region}
        S3Key: ec752f3715523ecd107a57d22b87868d0d430eb39df66225e59c385bd30cd6a0.zip
      Environment:
        Variables:
          LOG_LEVEL: INFO
          STATE_MACHINE_ARN:
            Ref: ProcessorDocumentProcessingStateMachineE572AD61
          APPSYNC_API_URL:
            Fn::GetAtt:
              - EnvironmentApiD8145510
              - GraphQLUrl
          CONCURRENCY_TABLE:
            Ref: EnvironmentConcurrencyTableE6976F31
          MAX_CONCURRENT: "100"
      Handler: index.handler
      Layers:
        - Ref: comamazonawscdkcdklabsgenaiidpidpcommonlayer5E5CC073
      LoggingConfig:
        LogGroup:
          Ref: ProcessorQueueProcessorLogGroup4C043267
      Role:
        Fn::GetAtt:
          - ProcessorQueueProcessorServiceRole7E551AE5
          - Arn
      Runtime: python3.12
      Timeout: 30
    DependsOn:
      - ProcessorQueueProcessorServiceRoleDefaultPolicy631EF7BF
      - ProcessorQueueProcessorServiceRole7E551AE5
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorQueueProcessorSqsEventSourcePattern2TestStackEnvironmentDocumentQueue30160F4C70CFEB68:
    Type: AWS::Lambda::EventSourceMapping
    Properties:
      BatchSize: 50
      EventSourceArn:
        Fn::GetAtt:
          - EnvironmentDocumentQueue95D3B000
          - Arn
      FunctionName:
        Ref: ProcessorQueueProcessorF002AD81
      FunctionResponseTypes:
        - ReportBatchItemFailures
      MaximumBatchingWindowInSeconds: 1
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorS3EventRuleF45035FA:
    Type: AWS::Events::Rule
    Properties:
      EventPattern:
        source:
          - aws.s3
        detail-type:
          - Object Created
        detail:
          bucket:
            name:
              - Ref: InputBucket3BF8630A
      State: ENABLED
      Targets:
        - Arn:
            Fn::GetAtt:
              - EnvironmentQueueSender29E9D2B0
              - Arn
          Id: Target0
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorS3EventRuleAllowEventRulePattern2TestStackEnvironmentQueueSenderCFAE80F162B978E1:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
          - EnvironmentQueueSender29E9D2B0
          - Arn
      Principal: events.amazonaws.com
      SourceArn:
        Fn::GetAtt:
          - ProcessorS3EventRuleF45035FA
          - Arn
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorWorkflowStateChangeRule5A268BAD:
    Type: AWS::Events::Rule
    Properties:
      EventPattern:
        source:
          - aws.states
        detail-type:
          - Step Functions Execution Status Change
        detail:
          stateMachineArn:
            - Ref: ProcessorDocumentProcessingStateMachineE572AD61
          status:
            - FAILED
            - TIMED_OUT
            - ABORTED
            - SUCCEEDED
      State: ENABLED
      Targets:
        - Arn:
            Fn::GetAtt:
              - EnvironmentWorkflowTrackerFC27ADDE
              - Arn
          Id: Target0
          RetryPolicy:
            MaximumEventAgeInSeconds: 7200
            MaximumRetryAttempts: 3
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
  ProcessorWorkflowStateChangeRuleAllowEventRulePattern2TestStackEnvironmentWorkflowTracker8E3C7DCB6D8EC462:
    Type: AWS::Lambda::Permission
    Properties:
      Action: lambda:InvokeFunction
      FunctionName:
        Fn::GetAtt:
          - EnvironmentWorkflowTrackerFC27ADDE
          - Arn
      Principal: events.amazonaws.com
      SourceArn:
        Fn::GetAtt:
          - ProcessorWorkflowStateChangeRule5A268BAD
          - Arn
    UpdateReplacePolicy: Delete
    DeletionPolicy: Delete
Mappings:
  LatestNodeRuntimeMap:
    af-south-1:
      value: nodejs20.x
    ap-east-1:
      value: nodejs20.x
    ap-east-2:
      value: nodejs20.x
    ap-northeast-1:
      value: nodejs20.x
    ap-northeast-2:
      value: nodejs20.x
    ap-northeast-3:
      value: nodejs20.x
    ap-south-1:
      value: nodejs20.x
    ap-south-2:
      value: nodejs20.x
    ap-southeast-1:
      value: nodejs20.x
    ap-southeast-2:
      value: nodejs20.x
    ap-southeast-3:
      value: nodejs20.x
    ap-southeast-4:
      value: nodejs20.x
    ap-southeast-5:
      value: nodejs20.x
    ap-southeast-7:
      value: nodejs20.x
    ca-central-1:
      value: nodejs20.x
    ca-west-1:
      value: nodejs20.x
    cn-north-1:
      value: nodejs20.x
    cn-northwest-1:
      value: nodejs20.x
    eu-central-1:
      value: nodejs20.x
    eu-central-2:
      value: nodejs20.x
    eu-isoe-west-1:
      value: nodejs18.x
    eu-north-1:
      value: nodejs20.x
    eu-south-1:
      value: nodejs20.x
    eu-south-2:
      value: nodejs20.x
    eu-west-1:
      value: nodejs20.x
    eu-west-2:
      value: nodejs20.x
    eu-west-3:
      value: nodejs20.x
    il-central-1:
      value: nodejs20.x
    me-central-1:
      value: nodejs20.x
    me-south-1:
      value: nodejs20.x
    mx-central-1:
      value: nodejs20.x
    sa-east-1:
      value: nodejs20.x
    us-east-1:
      value: nodejs20.x
    us-east-2:
      value: nodejs20.x
    us-gov-east-1:
      value: nodejs20.x
    us-gov-west-1:
      value: nodejs20.x
    us-iso-east-1:
      value: nodejs18.x
    us-iso-west-1:
      value: nodejs18.x
    us-isob-east-1:
      value: nodejs18.x
    us-isob-west-1:
      value: nodejs18.x
    us-west-1:
      value: nodejs20.x
    us-west-2:
      value: nodejs20.x
Parameters:
  BootstrapVersion:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /cdk-bootstrap/hnb659fds/version
    Description: Version of the CDK Bootstrap resources in this environment, automatically retrieved from SSM Parameter Store. [cdk:skip]

